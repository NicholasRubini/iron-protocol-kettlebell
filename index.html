<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRON PROTOCOL | Kettlebell Command</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Bebas+Neue&family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5TEd8EaN4GTjD9ylEMH9I9nsig9o03r3e7Lw+T/z+i6u40qCMgfHdCDBpNNpJBbGAbI3IuShPnsd8y5x2Eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-bR6PvwsRWSavwgJeayW89tm3dGn/MaINmQ4AdU47gAEhK/cySqUZlFH/JhlObcSFXAuO5W91zr3HwB1C+duWGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --olive-dark: #2d3a1f;
            --olive: #4a5d23;
            --olive-light: #6b7f35;
            --blood-red: #8b0000;
            --danger-red: #c41e3a;
            --steel: #3a3a3a;
            --gunmetal: #2c3539;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent-gold: #c4a035;
            --warning-orange: #cc5500;
            --info-blue: #4a7c9b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(74,93,35,0.03) 1px, transparent 1px),
                linear-gradient(rgba(74,93,35,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
            pointer-events: none;
            z-index: 1000;
            opacity: 0.3;
        }

        .app-container {
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 3px solid var(--olive);
            padding: 20px 40px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'TACTICAL TRAINING';
            position: absolute;
            top: 10px;
            right: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 12px;
            color: var(--danger-red);
            letter-spacing: 4px;
            opacity: 0.6;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--olive-dark);
            border: 3px solid var(--olive);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            clip-path: polygon(15% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%, 0% 15%);
        }

        .logo-icon svg {
            width: 40px;
            height: 40px;
            fill: var(--text-primary);
        }

        .logo-text h1 {
            font-family: 'Black Ops One', cursive;
            font-size: 2.5rem;
            letter-spacing: 4px;
            color: var(--text-primary);
            text-shadow: 2px 2px 0 var(--olive-dark);
        }

        .logo-text p {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 6px;
            color: var(--olive-light);
            margin-top: -5px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-block {
            text-align: center;
            padding: 10px 20px;
            border: 1px solid var(--steel);
            background: rgba(0,0,0,0.3);
        }

        .stat-block .value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
        }

        .stat-block .label {
            font-size: 0.7rem;
            letter-spacing: 2px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            border: 2px solid var(--steel);
            background: rgba(0,0,0,0.3);
            margin-right: 20px;
        }

        .lang-btn {
            padding: 8px 15px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            color: var(--text-primary);
        }

        .lang-btn.active {
            background: var(--olive);
            color: #fff;
        }

        .main-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 25px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--steel);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--olive-dark) 100%);
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-bottom: 1px solid var(--steel);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-header-icon {
            width: 26px;
            height: 26px;
            background: var(--olive-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            clip-path: polygon(0% 15%, 15% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%);
        }

        .panel-header-icon svg {
            width: 14px;
            height: 14px;
            fill: var(--olive-light);
        }

        .panel-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 3px;
            color: var(--text-primary);
        }

        .panel-header .designation {
            margin-left: auto;
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        .panel-body {
            padding: 20px;
            /* No max-height on desktop - show everything */
        }

        .panel-body::-webkit-scrollbar {
            width: 8px;
        }

        .panel-body::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .panel-body::-webkit-scrollbar-thumb {
            background: var(--olive-dark);
            border: 1px solid var(--olive);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .form-label .required {
            color: var(--danger-red);
        }

        .goal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .goal-option {
            position: relative;
        }

        .goal-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .goal-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .goal-card:hover {
            border-color: var(--olive);
            background: rgba(74,93,35,0.1);
        }

        .goal-option input:checked + .goal-card {
            border-color: var(--olive-light);
            background: var(--olive-dark);
            box-shadow: 0 0 20px rgba(74,93,35,0.3);
        }

        .goal-card svg {
            width: 22px;
            height: 22px;
            fill: var(--text-secondary);
            margin-bottom: 5px;
            transition: fill 0.3s ease;
        }

        .goal-option input:checked + .goal-card svg {
            fill: var(--olive-light);
        }

        .goal-card .goal-name {
            font-family: 'Oswald', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .goal-card .goal-desc {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .equipment-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .equip-option {
            flex: 1;
            position: relative;
        }

        .equip-option input {
            position: absolute;
            opacity: 0;
        }

        .equip-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 10px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .equip-btn:hover {
            border-color: var(--olive);
        }

        .equip-option input:checked + .equip-btn {
            border-color: var(--accent-gold);
            background: rgba(196,160,53,0.1);
        }

        .equip-btn svg {
            width: 32px;
            height: 32px;
            fill: var(--text-secondary);
            margin-bottom: 6px;
        }

        .equip-option input:checked + .equip-btn svg {
            fill: var(--accent-gold);
        }

        .equip-btn .equip-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .equip-btn .equip-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .level-selector {
            display: flex;
            gap: 8px;
        }

        .level-option {
            flex: 1;
            position: relative;
        }

        .level-option input {
            position: absolute;
            opacity: 0;
        }

        .level-btn {
            display: block;
            padding: 10px 8px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-btn:hover {
            border-color: var(--olive);
        }

        .level-option input:checked + .level-btn {
            border-color: var(--danger-red);
            background: rgba(139,0,0,0.2);
        }

        .level-btn .rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            letter-spacing: 1px;
        }

        .level-btn .time {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .tactical-select {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            color: var(--text-primary);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236b7f35' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            transition: all 0.3s ease;
        }

        .tactical-select:hover, .tactical-select:focus {
            border-color: var(--olive);
            outline: none;
        }

        .tactical-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .range-container {
            position: relative;
            padding: 5px 0;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            appearance: none;
            cursor: pointer;
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--olive);
            border: 2px solid var(--olive-light);
            cursor: pointer;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }

        .range-value {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .range-value span {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .range-value .current {
            color: var(--accent-gold);
            font-size: 1.1rem;
        }

        .exercise-category {
            margin-bottom: 10px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            margin-bottom: 5px;
            cursor: pointer;
        }

        .category-header h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .category-header .toggle-all {
            font-size: 0.65rem;
            color: var(--accent-gold);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .category-header .toggle-all:hover {
            text-decoration: underline;
        }

        .exercise-list-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .exercise-checkbox {
            position: relative;
        }

        .exercise-checkbox input {
            position: absolute;
            opacity: 0;
        }

        .exercise-checkbox label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--steel);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .exercise-checkbox label:hover {
            border-color: var(--olive);
            background: rgba(74,93,35,0.1);
        }

        .exercise-checkbox input:checked + label {
            border-color: var(--olive-light);
            background: var(--olive-dark);
        }

        .exercise-checkbox input:disabled + label {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .exercise-checkbox .check-icon {
            width: 18px;
            height: 18px;
            border: 2px solid var(--steel);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exercise-checkbox input:checked + label .check-icon {
            background: var(--olive);
            border-color: var(--olive-light);
        }

        .exercise-checkbox input:checked + label .check-icon::after {
            content: '✓';
            color: var(--text-primary);
            font-size: 12px;
        }

        .exercise-checkbox .ex-name {
            flex: 1;
            font-family: 'Roboto Condensed', sans-serif;
        }

        .exercise-checkbox .double-tag {
            font-size: 0.6rem;
            padding: 2px 5px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .exercise-checkbox .ballistic-tag {
            font-size: 0.55rem;
            padding: 2px 5px;
            background: var(--warning-orange);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .generate-btn {
            width: 100%;
            padding: 16px 40px;
            background: linear-gradient(180deg, var(--blood-red) 0%, #5a0000 100%);
            border: 3px solid var(--danger-red);
            color: var(--text-primary);
            font-family: 'Black Ops One', cursive;
            font-size: 1.1rem;
            letter-spacing: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: sticky;
            bottom: 0;
            overflow: hidden;
            margin-top: 15px;
            clip-path: polygon(0% 0%, 95% 0%, 100% 50%, 95% 100%, 0% 100%, 5% 50%);
            z-index: 10;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        .generate-btn:hover {
            background: linear-gradient(180deg, var(--danger-red) 0%, var(--blood-red) 100%);
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(196,30,58,0.4);
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .generate-btn::before {
            content: '▶▶';
            margin-right: 15px;
            font-size: 0.9rem;
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .selection-warning {
            background: rgba(196,30,58,0.1);
            border: 1px solid var(--danger-red);
            padding: 12px;
            margin-top: 10px;
            text-align: center;
        }

        .selection-warning p {
            font-size: 0.8rem;
            color: var(--danger-red);
        }

        .selection-count {
            text-align: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            margin-bottom: 20px;
        }

        .selection-count .number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-gold);
        }

        .selection-count .text {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .program-panel {
            grid-column: 1 / -1;
        }

        .program-output {
            min-height: 400px;
            display: none;
        }

        .program-output.active {
            display: block;
        }

        .workout-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            margin-bottom: 20px;
            position: relative;
        }

        .workout-block::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
        }

        .workout-block.main::before { background: var(--danger-red); }
        .workout-block.accessory::before { background: var(--olive); }
        .workout-block.finisher::before { background: var(--warning-orange); }

        .workout-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--steel);
        }

        .workout-block-header h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-tag {
            padding: 3px 10px;
            font-size: 0.65rem;
            letter-spacing: 1px;
            color: var(--bg-primary);
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
        }

        .main .phase-tag { background: var(--danger-red); }
        .accessory .phase-tag { background: var(--olive); }
        .finisher .phase-tag { background: var(--warning-orange); }

        .duration-badge {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            color: var(--accent-gold);
        }

        .exercise-list-output {
            padding: 20px;
        }

        .exercise-item {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            gap: 15px;
            align-items: start;
            padding: 15px;
            background: var(--bg-secondary);
            margin-bottom: 10px;
            border-left: 3px solid var(--steel);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .exercise-item:hover {
            border-left-color: var(--olive);
            background: rgba(74,93,35,0.1);
        }

        .exercise-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--text-muted);
            text-align: center;
        }

        .exercise-details h4 {
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--text-primary);
            text-transform: uppercase;
        }

        .exercise-details p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .exercise-details .method-tag {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .method-tag.ladder {
            background: var(--info-blue);
            color: var(--text-primary);
        }

        .method-tag.cluster {
            background: var(--warning-orange);
            color: var(--bg-primary);
        }

        .method-tag.straight {
            background: var(--steel);
            color: var(--text-primary);
        }

        .exercise-prescription {
            text-align: right;
            min-width: 140px;
        }

        .exercise-prescription .sets-reps {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .exercise-prescription .rep-range-note {
            font-size: 0.7rem;
            color: var(--accent-gold);
            margin-top: 2px;
        }

        .exercise-prescription .rest {
            font-size: 0.75rem;
            color: var(--olive-light);
            margin-top: 4px;
        }

        .exercise-prescription .tempo {
            font-size: 0.7rem;
            color: var(--accent-gold);
            margin-top: 2px;
        }

        .exercise-prescription .method-detail {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
        }

        .program-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .summary-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--olive);
        }

        .summary-card .metric {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-gold);
        }

        .summary-card .metric-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            flex: 1;
            padding: 15px 25px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            color: var(--text-primary);
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
        }

        .action-btn:hover {
            border-color: var(--olive);
            background: rgba(74,93,35,0.2);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--olive-light);
        }

        .action-btn.primary {
            background: var(--olive-dark);
            border-color: var(--olive);
        }

        .action-btn.primary:hover {
            background: var(--olive);
        }

        .timer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .timer-overlay.active {
            display: flex;
        }

        .timer-container {
            background: var(--bg-secondary);
            border: 3px solid var(--olive);
            padding: 50px;
            text-align: center;
            position: relative;
            min-width: 400px;
        }

        .timer-container::before {
            content: 'REST TIMER';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--olive);
            padding: 5px 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 3px;
            color: var(--bg-primary);
        }

        .timer-exercise {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .timer-display {
            font-family: 'Black Ops One', cursive;
            font-size: 6rem;
            color: var(--accent-gold);
            text-shadow: 0 0 30px rgba(196,160,53,0.3);
            margin: 30px 0;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .timer-btn {
            padding: 15px 40px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-btn:hover {
            border-color: var(--olive);
        }

        .timer-btn.start {
            background: var(--olive-dark);
            border-color: var(--olive);
        }

        .timer-btn.stop {
            background: var(--blood-red);
            border-color: var(--danger-red);
        }

        .timer-btn.close {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            font-size: 1rem;
        }

        .program-notes {
            background: rgba(196,160,53,0.05);
            border: 1px solid var(--accent-gold);
            padding: 20px;
            margin-top: 25px;
        }

        .program-notes h4 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--accent-gold);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .program-notes ul {
            list-style: none;
            padding-left: 0;
        }

        .program-notes li {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .program-notes li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: var(--olive-light);
        }

        /* Progression timeline */
        .progression-overview {
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            padding: 20px;
            margin-bottom: 25px;
        }

        .progression-overview h4 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progression-timeline {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .progression-week {
            flex: 1;
            min-width: 120px;
            background: var(--bg-secondary);
            border: 1px solid var(--steel);
            padding: 12px;
            text-align: center;
            position: relative;
        }

        .progression-week::after {
            content: '→';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--olive);
            font-size: 1rem;
            z-index: 1;
        }

        .progression-week:last-child::after {
            display: none;
        }

        .progression-week.deload {
            background: rgba(196,160,53,0.1);
            border-color: var(--accent-gold);
        }

        .progression-week .week-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            color: var(--olive-light);
            margin-bottom: 5px;
        }

        .progression-week.deload .week-num {
            color: var(--accent-gold);
        }

        .progression-week .week-focus {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        /* Week content areas */
        .weeks-container {
            position: relative;
        }

        .week-content {
            display: none;
        }

        .week-content.active {
            display: block;
        }

        .week-header {
            background: linear-gradient(90deg, var(--olive-dark) 0%, transparent 100%);
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--olive);
        }

        .week-header.deload-header {
            background: linear-gradient(90deg, rgba(196,160,53,0.2) 0%, transparent 100%);
            border-left-color: var(--accent-gold);
        }

        .week-header .week-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .week-header.deload-header .week-title {
            color: var(--accent-gold);
        }

        .week-header .week-progression-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Deload tab styling */
        .week-tab.deload-tab {
            color: var(--accent-gold);
        }

        .week-tab.deload-tab.active {
            color: var(--accent-gold);
        }

        .week-tab.deload-tab.active::after {
            background: var(--accent-gold);
        }

        /* Deload exercise/block styling */
        .workout-block.deload-block {
            opacity: 0.85;
        }

        .workout-block.deload-block::before {
            background: var(--accent-gold) !important;
        }

        .exercise-item.deload-exercise {
            border-left-color: var(--accent-gold);
        }

        /* Method explanation boxes */
        .method-explanation {
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            padding: 20px;
            margin-top: 20px;
        }

        .method-explanation h4 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .method-explanation h4 .tag {
            padding: 3px 8px;
            font-size: 0.65rem;
        }

        .method-explanation p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .method-explanation .example {
            background: var(--bg-primary);
            padding: 12px 15px;
            margin-top: 10px;
            border-left: 3px solid var(--olive);
        }

        .method-explanation .example code {
            font-family: 'Roboto Condensed', sans-serif;
            color: var(--accent-gold);
        }

        .load-adjustment-note {
            background: rgba(74,93,35,0.1);
            border: 1px solid var(--olive);
            padding: 15px;
            margin-top: 20px;
        }

        .load-adjustment-note h5 {
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            letter-spacing: 1px;
            color: var(--olive-light);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .load-adjustment-note p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .placeholder-state {
            text-align: center;
            padding: 60px 40px;
        }

        .placeholder-state svg {
            width: 80px;
            height: 80px;
            fill: var(--steel);
            margin-bottom: 25px;
        }

        .placeholder-state h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .placeholder-state p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .week-tabs {
            display: flex;
            border-bottom: 2px solid var(--steel);
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .week-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .week-tab:hover {
            color: var(--text-secondary);
        }

        .week-tab.active {
            color: var(--text-primary);
        }

        .week-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--olive);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--steel);
            border-top: 4px solid var(--olive);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 3px;
            color: var(--text-muted);
        }

        .footer {
            text-align: center;
            padding: 30px;
            border-top: 1px solid var(--steel);
            margin-top: 40px;
        }

        .footer p {
            font-size: 0.8rem;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        /* Warning Modal */
        .warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .warning-modal-content {
            background: var(--bg-secondary);
            border: 3px solid var(--accent-gold);
            max-width: 500px;
            width: 90%;
        }

        .warning-modal-header {
            background: var(--accent-gold);
            padding: 15px 20px;
        }

        .warning-modal-header h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            color: var(--bg-primary);
            margin: 0;
        }

        .warning-modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .warning-item {
            display: flex;
            gap: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .warning-item.critical {
            background: rgba(196,30,58,0.1);
            border-color: var(--danger-red);
        }

        .warning-item.warning {
            background: rgba(196,160,53,0.1);
            border-color: var(--accent-gold);
        }

        .warning-item.info {
            background: rgba(74,124,155,0.1);
            border-color: var(--info-blue);
        }

        .warning-item .warning-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .warning-item p {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin: 0;
        }

        .warning-modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--steel);
        }

        .warning-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .warning-btn.proceed {
            background: var(--olive-dark);
            border-color: var(--olive);
            color: var(--text-primary);
        }

        .warning-btn.proceed:hover {
            background: var(--olive);
        }

        .warning-btn.cancel {
            background: transparent;
            border-color: var(--steel);
            color: var(--text-secondary);
        }

        .warning-btn.cancel:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        /* Intensity Profile badges */
        .intensity-badge {
            padding: 3px 8px;
            font-size: 0.65rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .intensity-badge.heavy {
            background: var(--danger-red);
            color: #fff;
        }

        .intensity-badge.light {
            background: var(--info-blue);
            color: #fff;
        }

        .intensity-badge.medium {
            background: var(--olive);
            color: #fff;
        }

        /* Load guidance for strength program */
        .load-guidance {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-top: 5px;
            padding: 3px 8px;
            background: rgba(196,160,53,0.15);
            border-left: 2px solid var(--accent-gold);
        }

        /* RPE badge */
        .rpe-badge {
            padding: 3px 8px;
            font-size: 0.65rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-left: 10px;
            background: rgba(196,160,53,0.2);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Intensity description */
        .intensity-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 8px 15px;
            background: rgba(74,93,35,0.1);
            border-left: 3px solid var(--olive);
            margin-bottom: 10px;
        }

        /* Primary exercise highlight */
        .exercise-item.primary-lift {
            border-left: 4px solid var(--danger-red);
            background: rgba(196,30,58,0.05);
        }

        .exercise-item.secondary-lift {
            border-left: 4px solid var(--steel);
            opacity: 0.9;
        }

        /* Preset Programs Section */
        .preset-section {
            grid-column: 1 / -1;
            margin-bottom: 30px;
        }

        .preset-header {
            margin-bottom: 20px;
        }

        .preset-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 3px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .preset-header h2 svg {
            fill: var(--olive);
        }

        .preset-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .preset-card {
            background: var(--bg-secondary);
            border: 2px solid var(--steel);
            padding: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--olive);
        }

        .preset-card:hover {
            border-color: var(--olive);
            transform: translateY(-3px);
        }

        .preset-card.selected {
            border-color: var(--accent-gold);
            background: rgba(196,160,53,0.1);
        }

        .preset-card.selected::before {
            background: var(--accent-gold);
        }

        .preset-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: var(--olive);
            color: #fff;
            font-family: 'Oswald', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 2px;
            padding: 4px 12px;
        }

        .preset-badge.power {
            background: var(--warning-orange);
        }

        .preset-badge.fitness {
            background: var(--info-blue);
        }

        .preset-badge.hypertrophy {
            background: var(--danger-red);
        }

        .preset-card h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            margin-bottom: 8px;
            margin-top: 5px;
        }

        .preset-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .preset-features {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        .preset-features li {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 4px 0;
            padding-left: 15px;
            position: relative;
        }

        .preset-features li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--olive);
            font-weight: bold;
        }

        .preset-exercises {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .preset-exercises span {
            font-size: 0.7rem;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--steel);
            color: var(--text-secondary);
        }

        .preset-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid var(--olive);
            color: var(--olive);
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: var(--olive);
            color: #fff;
        }

        .preset-card.selected .preset-btn {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        .preset-divider {
            text-align: center;
            margin: 30px 0 20px;
            position: relative;
        }

        .preset-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--steel);
        }

        .preset-divider span {
            position: relative;
            background: var(--bg-primary);
            padding: 0 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 3px;
            color: var(--text-muted);
        }

        @media (max-width: 1200px) {
            .preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .preset-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Toast notification */
        .preset-toast {
            position: fixed;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--olive);
            color: #fff;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            border: 2px solid var(--olive-light);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            transition: bottom 0.3s ease;
        }

        .preset-toast.show {
            bottom: 30px;
        }

        .preset-toast svg {
            flex-shrink: 0;
        }

        /* Editable exercise indicators */
        .exercise-item {
            cursor: pointer;
            position: relative;
        }

        .exercise-item::after {
            content: '✎';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .exercise-item:hover::after {
            opacity: 1;
        }

        .exercise-item:hover {
            background: rgba(74,93,35,0.1);
            border-color: var(--olive);
        }

        /* Edit Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .edit-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .edit-modal-content {
            background: var(--bg-secondary);
            border: 3px solid var(--olive);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-modal-header {
            background: linear-gradient(90deg, var(--olive-dark) 0%, var(--olive) 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            margin: 0;
        }

        .edit-modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .edit-modal-body {
            padding: 20px;
        }

        .edit-exercise-name {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .edit-exercise-pattern {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--steel);
        }

        .edit-field {
            margin-bottom: 20px;
        }

        .edit-field label {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .edit-field input,
        .edit-field select {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            color: var(--text-primary);
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 1rem;
        }

        .edit-field input:focus,
        .edit-field select:focus {
            outline: none;
            border-color: var(--olive);
        }

        .edit-field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .edit-field-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .edit-modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--steel);
        }

        .edit-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .edit-btn.save {
            background: var(--olive);
            border-color: var(--olive);
            color: #fff;
        }

        .edit-btn.save:hover {
            background: var(--olive-light);
            border-color: var(--olive-light);
        }

        .edit-btn.cancel {
            background: transparent;
            border-color: var(--steel);
            color: var(--text-secondary);
        }

        .edit-btn.cancel:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .edit-method-info {
            background: rgba(74,124,155,0.1);
            border-left: 3px solid var(--info-blue);
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Edited indicator */
        .exercise-item.edited {
            border-left-color: var(--accent-gold) !important;
        }

        .exercise-item.edited::before {
            content: 'MODIFICATO';
            position: absolute;
            top: -8px;
            left: 15px;
            font-size: 0.6rem;
            font-family: 'Oswald', sans-serif;
            letter-spacing: 1px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            padding: 2px 6px;
        }

        /* User notes on exercises */
        .user-note {
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-top: 8px;
            padding: 5px 10px;
            background: rgba(196,160,53,0.1);
            border-left: 2px solid var(--accent-gold);
        }

        /* Propagation Modal Styles */
        .propagate-content {
            max-width: 500px;
        }

        .propagate-header {
            background: linear-gradient(90deg, #2a4a7a 0%, #4a7ab4 100%);
        }

        .propagate-question {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 500;
        }

        .propagate-exercise-info {
            background: var(--bg-tertiary);
            padding: 12px 15px;
            margin-bottom: 20px;
            border-left: 3px solid var(--info-blue);
        }

        .propagate-exercise-info strong {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .propagate-exercise-info span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .propagate-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .propagate-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .propagate-option:hover {
            border-color: var(--olive);
        }

        .propagate-option input[type="radio"] {
            margin-top: 3px;
            accent-color: var(--olive);
            width: 18px;
            height: 18px;
        }

        .propagate-option input[type="radio"]:checked + .propagate-option-content {
            color: var(--text-primary);
        }

        .propagate-option:has(input:checked) {
            border-color: var(--olive);
            background: rgba(74,93,35,0.1);
        }

        .propagate-option-content {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .propagate-option-title {
            font-family: 'Oswald', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .propagate-option-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .propagate-range {
            margin-left: 30px;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--steel);
        }

        .range-inputs {
            display: flex;
            gap: 20px;
        }

        .range-inputs label {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .range-inputs select {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--steel);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .propagate-preview {
            background: rgba(74,93,35,0.15);
            border: 1px solid var(--olive);
            padding: 12px 15px;
        }

        .preview-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .preview-weeks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preview-week-badge {
            padding: 5px 10px;
            background: var(--olive);
            color: #fff;
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .preview-week-badge.current {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .preview-week-badge.deload {
            background: var(--info-blue);
        }

        /* Propagated indicator */
        .exercise-item.propagated::before {
            content: 'PROPAGATO';
            position: absolute;
            top: -8px;
            left: 15px;
            font-size: 0.6rem;
            font-family: 'Oswald', sans-serif;
            letter-spacing: 1px;
            background: var(--info-blue);
            color: #fff;
            padding: 2px 6px;
        }

        .exercise-item.edited.propagated::before {
            content: 'MODIFICATO • PROPAGATO';
            background: linear-gradient(90deg, var(--accent-gold) 50%, var(--info-blue) 50%);
        }

        /* Autoregulation section */
        .autoregulation-notes {
            background: rgba(74,124,155,0.1);
            border: 1px solid var(--info-blue);
            padding: 20px;
            margin-top: 15px;
        }

        .autoregulation-notes h4 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--info-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .autoregulation-notes ul {
            list-style: none;
            padding-left: 0;
        }

        .autoregulation-notes li {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .autoregulation-notes li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--info-blue);
        }
        
        /* Mobile generate button - hidden by default */
        .mobile-generate-btn {
            display: none;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
            
            .program-panel {
                grid-column: 1 / -1;
            }
            
            /* Reduce exercise columns on tablets */
            .exercise-list-select {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 10px;
                padding-bottom: 80px; /* Space for sticky button */
            }

            .header-stats {
                display: none;
            }
            
            .header-content {
                padding: 10px 15px;
            }
            
            .logo-section h1 {
                font-size: 1.3rem;
            }
            
            .logo-section .subtitle {
                font-size: 0.6rem;
            }

            .program-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Stack exercise details for better readability on mobile */
            .exercise-item {
                grid-template-columns: auto 1fr;
                grid-template-areas:
                    "number details"
                    "prescription prescription";
                gap: 12px;
            }

            .exercise-number { grid-area: number; }
            .exercise-details { grid-area: details; }
            .exercise-prescription {
                grid-area: prescription;
                text-align: left;
                min-width: auto;
                width: 100%;
                padding: 12px 14px;
                background: rgba(255,255,255,0.03);
                border: 1px solid var(--steel);
                border-radius: 8px;
            }

            .exercise-prescription .sets-reps {
                font-size: 1.1rem;
            }

            .exercise-prescription .rest,
            .exercise-prescription .rep-range-note,
            .exercise-prescription .tempo {
                display: inline-flex;
                flex-wrap: wrap;
                gap: 4px;
                align-items: center;
            }

            /* Compact goal grid - 2 columns */
            .goal-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .goal-card {
                padding: 10px 8px;
            }
            
            .goal-card svg {
                width: 20px;
                height: 20px;
                margin-bottom: 5px;
            }
            
            .goal-card .goal-name {
                font-size: 0.75rem;
            }
            
            .goal-card .goal-desc {
                font-size: 0.55rem;
            }
            
            /* Compact equipment toggle */
            .equipment-toggle {
                flex-direction: row;
                gap: 8px;
            }
            
            .equip-btn {
                padding: 12px 8px;
            }
            
            .equip-btn svg {
                width: 28px;
                height: 28px;
                margin-bottom: 5px;
            }
            
            .equip-btn .equip-name {
                font-size: 0.85rem;
            }
            
            .equip-btn .equip-desc {
                font-size: 0.6rem;
            }
            
            /* Compact level selector */
            .level-selector {
                gap: 6px;
            }
            
            .level-btn {
                padding: 8px 5px;
            }
            
            .level-btn .rank {
                font-size: 0.85rem;
            }
            
            .level-btn .time {
                font-size: 0.55rem;
            }
            
            /* Compact selects */
            .tactical-select {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            /* Compact exercise list */
            .exercise-list-select {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .exercise-checkbox label {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .exercise-checkbox .ex-name {
                font-size: 0.75rem;
            }
            
            /* Panel compact */
            .panel {
                margin-bottom: 10px;
            }
            
            .panel-header {
                padding: 12px 15px;
            }
            
            .panel-header h2 {
                font-size: 1rem;
            }
            
            .panel-body {
                padding: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-label {
                font-size: 0.75rem;
                margin-bottom: 8px;
            }
            
            /* Exercise category compact */
            .category-title {
                font-size: 0.7rem;
                padding: 5px 10px;
                margin-bottom: 8px;
            }
            
            .exercise-category {
                margin-bottom: 8px;
            }
            
            /* Collapsible categories on mobile */
            .category-header {
                position: relative;
                padding-right: 40px;
            }
            
            .category-header::after {
                content: '▼';
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.7rem;
                color: var(--olive);
                transition: transform 0.3s ease;
            }
            
            .exercise-category.collapsed .category-header::after {
                transform: translateY(-50%) rotate(-90deg);
            }
            
            .exercise-category.collapsed .exercise-list-select {
                display: none;
            }
            
            .category-header h3 {
                font-size: 0.8rem;
            }
            
            /* Preset cards compact */
            .preset-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .preset-card {
                padding: 15px;
            }
            
            .preset-card h3 {
                font-size: 1.1rem;
            }
            
            .preset-description {
                font-size: 0.8rem;
            }
            
            .preset-features li {
                font-size: 0.75rem;
            }
            
            /* Range slider compact */
            .range-container {
                padding: 5px 0;
            }
            
            /* Hide original generate button on mobile - we'll use sticky one */
            .generate-btn {
                display: none;
            }
            
            /* Sticky Generate Button for Mobile */
            .mobile-generate-btn {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                padding: 14px 20px;
                background: linear-gradient(180deg, var(--blood-red) 0%, #5a0000 100%);
                border: none;
                border-top: 3px solid var(--danger-red);
                color: var(--text-primary);
                font-family: 'Black Ops One', cursive;
                font-size: 1.1rem;
                letter-spacing: 3px;
                cursor: pointer;
                align-items: center;
                justify-content: center;
                gap: 10px;
                box-shadow: 0 -4px 20px rgba(139,0,0,0.5);
                animation: pulseGlow 2s ease-in-out infinite;
            }
            
            @keyframes pulseGlow {
                0%, 100% {
                    box-shadow: 0 -4px 20px rgba(139,0,0,0.5);
                }
                50% {
                    box-shadow: 0 -4px 30px rgba(139,0,0,0.8), 0 0 15px rgba(196,160,53,0.3);
                }
            }
            
            .mobile-generate-btn svg {
                width: 24px;
                height: 24px;
                fill: currentColor;
            }
            
            .mobile-generate-btn:active {
                transform: scale(0.98);
                animation: none;
            }
            
            .mobile-generate-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                animation: none;
            }
            
            /* Preset section compact */
            .preset-section {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .preset-section h2 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            /* Selection count badge compact */
            .selection-count {
                font-size: 0.8rem;
                padding: 3px 8px;
            }
        }
        
        /* Very small screens */
        @media (max-width: 480px) {
            .main-content {
                padding: 8px;
                padding-bottom: 75px;
            }
            
            .goal-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .goal-card {
                padding: 8px 6px;
            }
            
            .goal-card .goal-name {
                font-size: 0.7rem;
            }
            
            .goal-card .goal-desc {
                display: none; /* Hide description on very small screens */
            }
            
            .exercise-list-select {
                grid-template-columns: 1fr 1fr;
            }
            
            .exercise-checkbox label {
                padding: 6px 8px;
            }
            
            .exercise-checkbox .ex-name {
                font-size: 0.7rem;
            }
            
            .level-btn .time {
                display: none;
            }
            
            .mobile-generate-btn {
                font-size: 1rem;
                padding: 10px 15px;
            }
        }
        
        /* Desktop: hide mobile button, show original */
        @media (min-width: 769px) {
            .mobile-generate-btn {
                display: none !important;
            }
            
            .generate-btn {
                display: block !important;
            }
        }
        
        /* Large desktop: 4 columns for exercises */
        @media (min-width: 1400px) {
            .exercise-list-select {
                grid-template-columns: repeat(4, 1fr);
            }

            .main-content {
                max-width: 1900px;
            }
        }

        /* PDF export condensation */
        body.pdf-export {
            background: var(--bg-primary);
        }

        body.pdf-export .pdf-capture {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        body.pdf-export .program-summary {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        body.pdf-export .progression-overview {
            padding: 12px;
            margin-bottom: 12px;
        }

        body.pdf-export .week-tabs {
            display: none;
        }

        body.pdf-export .weeks-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }

        body.pdf-export .week-content {
            display: block !important;
        }

        body.pdf-export .week-header {
            margin-bottom: 10px;
            padding: 10px 12px;
        }

        body.pdf-export .workout-block {
            margin-bottom: 10px;
        }

        body.pdf-export .exercise-item {
            grid-template-columns: auto 1fr;
            grid-template-areas:
                "number details"
                "prescription prescription";
            gap: 12px;
        }

        body.pdf-export .exercise-number { grid-area: number; }
        body.pdf-export .exercise-details { grid-area: details; }
        body.pdf-export .exercise-prescription {
            grid-area: prescription;
            text-align: left;
            min-width: auto;
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--steel);
            border-radius: 8px;
        }

        body.pdf-export .exercise-prescription .sets-reps {
            font-size: 1.05rem;
        }

        /* Print Styles - Only show training program */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: #fff !important;
                color: #000 !important;
                font-size: 11pt;
            }

            body::before,
            body::after {
                display: none !important;
            }

            /* Hide non-essential elements */
            .header,
            .config-panel,
            .exercise-panel,
            .preset-section,
            .preset-toast,
            .edit-modal,
            .footer,
            .timer-overlay,
            .warning-modal,
            .action-buttons,
            .generate-btn,
            .selection-warning,
            .selection-count,
            .placeholder-state,
            .loading,
            .week-tabs {
                display: none !important;
            }

            .app-container {
                background: #fff;
            }

            .main-content {
                display: block !important;
                padding: 0 !important;
                max-width: 100% !important;
            }

            .panel {
                border: none !important;
                background: #fff !important;
            }

            .panel::before {
                display: none !important;
            }

            .panel-header {
                background: #1a1a1a !important;
                color: #fff !important;
                padding: 15px 20px !important;
                margin-bottom: 15px !important;
            }

            .panel-header h2 {
                color: #fff !important;
            }

            .panel-header .designation {
                display: none !important;
            }

            .panel-body {
                padding: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }

            .program-panel {
                width: 100% !important;
            }

            .program-output {
                display: block !important;
            }

            /* Program Summary Cards */
            .program-summary {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            .summary-card {
                background: #f5f5f5 !important;
                border: 2px solid #333 !important;
                padding: 15px !important;
                text-align: center !important;
            }

            .summary-card::after {
                background: #4a5d23 !important;
            }

            .summary-card .metric {
                color: #333 !important;
                font-size: 1.5rem !important;
            }

            .summary-card .metric-label {
                color: #666 !important;
            }

            /* Progression Overview */
            .progression-overview {
                background: #f9f9f9 !important;
                border: 2px solid #333 !important;
                padding: 15px !important;
                margin-bottom: 20px !important;
                page-break-inside: avoid;
            }

            .progression-overview h4 {
                color: #000 !important;
            }

            .progression-timeline {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
            }

            .progression-week {
                flex: 1 1 100px !important;
                min-width: 80px !important;
                background: #fff !important;
                border: 1px solid #333 !important;
                padding: 8px !important;
            }

            .progression-week::after {
                display: none !important;
            }

            .progression-week.deload {
                background: #fff3cd !important;
                border-color: #c4a035 !important;
            }

            .progression-week .week-num {
                color: #4a5d23 !important;
            }

            .progression-week.deload .week-num {
                color: #856404 !important;
            }

            .progression-week .week-focus {
                color: #333 !important;
                font-size: 8pt !important;
            }

            /* Method Explanation */
            .method-explanation {
                background: #f5f5f5 !important;
                border: 2px solid #333 !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }

            .method-explanation h4 {
                color: #000 !important;
            }

            .method-explanation p {
                color: #333 !important;
            }

            .method-explanation .example {
                background: #e9e9e9 !important;
                border-left: 3px solid #4a5d23 !important;
            }

            .method-explanation .example code {
                color: #000 !important;
                font-weight: bold !important;
            }

            /* Week Content - Show all weeks */
            .weeks-container {
                page-break-before: always;
            }

            .week-content {
                display: block !important;
                page-break-before: always;
                page-break-inside: avoid;
            }

            .week-content:first-child {
                page-break-before: avoid;
            }

            .week-header {
                background: linear-gradient(90deg, #4a5d23 0%, #fff 100%) !important;
                border-left: 4px solid #2d3a1f !important;
                padding: 12px 15px !important;
                margin-bottom: 15px !important;
            }

            .week-header .week-title {
                color: #000 !important;
                font-size: 14pt !important;
            }

            .week-header.deload-header {
                background: linear-gradient(90deg, #c4a035 0%, #fff 100%) !important;
                border-left-color: #856404 !important;
            }

            .week-header .week-progression-note {
                color: #333 !important;
            }

            /* Workout Blocks */
            .workout-block {
                background: #fff !important;
                border: 2px solid #333 !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }

            .workout-block::before {
                width: 4px !important;
            }

            .workout-block.main::before {
                background: #c41e3a !important;
            }

            .workout-block.accessory::before {
                background: #4a5d23 !important;
            }

            .workout-block.finisher::before {
                background: #cc5500 !important;
            }

            .workout-block-header {
                background: #f0f0f0 !important;
                border-bottom: 1px solid #333 !important;
                padding: 10px 15px !important;
            }

            .workout-block-header h3 {
                color: #000 !important;
                font-size: 11pt !important;
            }

            .phase-tag {
                color: #fff !important;
            }

            .main .phase-tag {
                background: #c41e3a !important;
            }

            .accessory .phase-tag {
                background: #4a5d23 !important;
            }

            .finisher .phase-tag {
                background: #cc5500 !important;
            }

            .duration-badge {
                color: #333 !important;
            }

            /* Exercise Items */
            .exercise-list-output {
                padding: 10px 15px !important;
            }

            .exercise-item {
                background: #fafafa !important;
                border: 1px solid #ddd !important;
                border-left: 3px solid #4a5d23 !important;
                margin-bottom: 8px !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }

            .exercise-number {
                color: #666 !important;
            }

            .exercise-details h4 {
                color: #000 !important;
                font-size: 10pt !important;
            }

            .exercise-details p {
                color: #666 !important;
                font-size: 9pt !important;
            }

            .method-tag {
                font-size: 7pt !important;
                padding: 2px 6px !important;
            }

            .method-tag.ladder {
                background: #4a7c9b !important;
                color: #fff !important;
            }

            .method-tag.cluster {
                background: #cc5500 !important;
                color: #fff !important;
            }

            .method-tag.straight {
                background: #666 !important;
                color: #fff !important;
            }

            .exercise-prescription {
                text-align: right !important;
            }

            .exercise-prescription .sets-reps {
                color: #000 !important;
                font-size: 11pt !important;
            }

            .exercise-prescription .rest,
            .exercise-prescription .tempo,
            .exercise-prescription .rep-range-note {
                color: #444 !important;
                font-size: 8pt !important;
            }

            /* Program Notes */
            .program-notes {
                background: #fffbeb !important;
                border: 2px solid #c4a035 !important;
                padding: 15px !important;
                margin-top: 20px !important;
                page-break-inside: avoid;
            }

            .program-notes h4 {
                color: #856404 !important;
            }

            .program-notes ul {
                margin: 0 !important;
                padding-left: 20px !important;
            }

            .program-notes li {
                color: #333 !important;
                font-size: 9pt !important;
                padding-left: 0 !important;
            }

            .program-notes li::before {
                content: '•' !important;
                color: #4a5d23 !important;
                position: static !important;
                margin-right: 8px !important;
            }

            /* Print header - add program title */
            .program-output::before {
                content: 'IRON PROTOCOL - KETTLEBELL TRAINING PROGRAM';
                display: block;
                font-family: 'Black Ops One', cursive;
                font-size: 18pt;
                text-align: center;
                padding: 20px 0;
                margin-bottom: 20px;
                border-bottom: 3px solid #4a5d23;
                color: #000;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 4.74 13.6 5.39 13 5.73V7H14C15.1 7 16 7.9 16 9V10H8V9C8 7.9 8.9 7 10 7H11V5.73C10.4 5.39 10 4.74 10 4C10 2.9 10.9 2 12 2M8 12H16V14H14V22H10V14H8V12Z"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>IRON PROTOCOL</h1>
                        <p data-i18n="subtitle">Centro Comando Allenamento Kettlebell</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="lang-toggle">
                        <button class="lang-btn active" data-lang="it">IT</button>
                        <button class="lang-btn" data-lang="en">EN</button>
                    </div>
                    <div class="stat-block">
                        <div class="value" id="programsGenerated">0</div>
                        <div class="label" data-i18n="stats.generated">Programmi Generati</div>
                    </div>
                    <div class="stat-block">
                        <div class="value">EBT</div>
                        <div class="label" data-i18n="stats.evidenceBased">Basato su Evidenze</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Preset Programs Section -->
            <div class="preset-section">
                <div class="preset-header">
                    <h2>
                        <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M9,17H7V10H9V17M13,17H11V7H13V17M17,17H15V13H17V17Z"/></svg>
                        <span data-i18n="presets.title">PROGRAMMI PRESET</span>
                    </h2>
                    <p data-i18n="presets.description">Seleziona un preset per avere subito un programma completo di 12 settimane. Puoi modificarlo successivamente.</p>
                </div>
                <div class="preset-grid">
                    <div class="preset-card" data-preset="strength">
                        <div class="preset-badge" data-i18n="presets.strength.badge">FORZA</div>
                        <h3>Iron Strength</h3>
                        <p class="preset-description" data-i18n="presets.strength.desc">Costruisci forza massimale con ladders e periodizzazione intelligente</p>
                        <ul class="preset-features">
                            <li>12 settimane • 3x/settimana</li>
                            <li>Ladders su 2 esercizi primari</li>
                            <li>Wave loading + intensificazione</li>
                        </ul>
                        <div class="preset-exercises">
                            <span>Deadlift</span><span>Military Press</span><span>Goblet Squat</span><span>Row</span><span>+3</span>
                        </div>
                        <button class="preset-btn" data-i18n="presets.select">SELEZIONA</button>
                    </div>
                    
                    <div class="preset-card" data-preset="power">
                        <div class="preset-badge power" data-i18n="presets.power.badge">POWER</div>
                        <h3>Explosive Power</h3>
                        <p class="preset-description" data-i18n="presets.power.desc">Sviluppa potenza esplosiva con clusters su esercizi balistici</p>
                        <ul class="preset-features">
                            <li>12 settimane • 3x/settimana</li>
                            <li>Clusters su swing/snatch/clean</li>
                            <li>Focus su velocità e qualità</li>
                        </ul>
                        <div class="preset-exercises">
                            <span>Snatch</span><span>Clean</span><span>Swing</span><span>Push Press</span><span>Row</span><span>+4</span>
                        </div>
                        <button class="preset-btn" data-i18n="presets.select">SELEZIONA</button>
                    </div>
                    
                    <div class="preset-card" data-preset="fitness">
                        <div class="preset-badge fitness" data-i18n="presets.fitness.badge">FITNESS</div>
                        <h3>Total Fitness</h3>
                        <p class="preset-description" data-i18n="presets.fitness.desc">Programma bilanciato per fitness generale e condizionamento</p>
                        <ul class="preset-features">
                            <li>12 settimane • 3x/settimana • 45 min</li>
                            <li>Volume controllato, tempo realistico</li>
                            <li>Finisher adattivi (leggeri nelle settimane peak)</li>
                        </ul>
                        <div class="preset-exercises">
                            <span>Swing</span><span>Goblet Squat</span><span>Press</span><span>Row</span><span>+2</span>
                        </div>
                        <button class="preset-btn" data-i18n="presets.select">SELEZIONA</button>
                    </div>
                    
                    <div class="preset-card" data-preset="hypertrophy">
                        <div class="preset-badge hypertrophy" data-i18n="presets.hypertrophy.badge">MASSA</div>
                        <h3>Muscle Builder</h3>
                        <p class="preset-description" data-i18n="presets.hypertrophy.desc">Massimizza l'ipertrofia con tempo controllato e volume progressivo</p>
                        <ul class="preset-features">
                            <li>12 settimane • 4x/settimana</li>
                            <li>Tempo 3-1-2-0 per TUT</li>
                            <li>Double progression</li>
                        </ul>
                        <div class="preset-exercises">
                            <span>Deadlift</span><span>Floor Press</span><span>Squat</span><span>Row</span><span>+4</span>
                        </div>
                        <button class="preset-btn" data-i18n="presets.select">SELEZIONA</button>
                    </div>
                </div>
                <div class="preset-divider">
                    <span data-i18n="presets.divider">OPPURE CONFIGURA MANUALMENTE</span>
                </div>
            </div>

            <!-- Panel 1: Training Parameters -->
            <div class="panel config-panel">
                <div class="panel-header">
                    <div class="panel-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10Z"/></svg>
                    </div>
                    <h2 data-i18n="config.title">Parametri Allenamento</h2>
                    <span class="designation">PARAM-001</span>
                </div>
                <div class="panel-body">
                    <!-- Equipment Selection -->
                    <div class="form-group">
                        <label class="form-label"><span data-i18n="config.equipment">Attrezzatura</span> <span class="required">*</span></label>
                        <div class="equipment-toggle">
                            <label class="equip-option">
                                <input type="radio" name="equipment" value="single" checked>
                                <div class="equip-btn">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3"/></svg>
                                    <span class="equip-name" data-i18n="config.singleKB">Singolo KB</span>
                                    <span class="equip-desc" data-i18n="config.singleKBDesc">Un kettlebell</span>
                                </div>
                            </label>
                            <label class="equip-option">
                                <input type="radio" name="equipment" value="double">
                                <div class="equip-btn">
                                    <svg viewBox="0 0 24 24"><circle cx="8" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="12" r="2"/><circle cx="16" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="16" cy="12" r="2"/></svg>
                                    <span class="equip-name" data-i18n="config.doubleKB">Doppio KB</span>
                                    <span class="equip-desc" data-i18n="config.doubleKBDesc">Coppia di kettlebell</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Goal Selection -->
                    <div class="form-group">
                        <label class="form-label"><span data-i18n="config.goal">Obiettivo Primario</span> <span class="required">*</span></label>
                        <div class="goal-grid">
                            <label class="goal-option">
                                <input type="radio" name="goal" value="general" checked>
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.general.name">Fitness Generale</span>
                                    <span class="goal-desc" data-i18n="config.goals.general.desc">Condizionamento completo</span>
                                </div>
                            </label>
                            <label class="goal-option">
                                <input type="radio" name="goal" value="strength">
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M20.57,14.86L22,13.43L20.57,12L17,15.57L8.43,7L12,3.43L10.57,2L9.14,3.43L7.71,2L5.57,4.14L4.14,2.71L2.71,4.14L4.14,5.57L2,7.71L3.43,9.14L2,10.57L3.43,12L7,8.43L15.57,17L12,20.57L13.43,22L14.86,20.57L16.29,22L18.43,19.86L19.86,21.29L21.29,19.86L19.86,18.43L22,16.29L20.57,14.86Z"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.strength.name">Forza Massimale</span>
                                    <span class="goal-desc" data-i18n="config.goals.strength.desc">Ladders • Basse ripetizioni</span>
                                </div>
                            </label>
                            <label class="goal-option">
                                <input type="radio" name="goal" value="power">
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M11,21H5V3H11V21M19,21H13V3H19V21Z"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.power.name">Potenza</span>
                                    <span class="goal-desc" data-i18n="config.goals.power.desc">Clusters • Esplosività</span>
                                </div>
                            </label>
                            <label class="goal-option">
                                <input type="radio" name="goal" value="hypertrophy">
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M12,5A2,2 0 0,1 14,7C14,7.24 13.96,7.47 13.88,7.69C17.95,8.5 21,11.91 21,16H3C3,11.91 6.05,8.5 10.12,7.69C10.04,7.47 10,7.24 10,7A2,2 0 0,1 12,5M22,19H2V17H22V19Z"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.hypertrophy.name">Ipertrofia</span>
                                    <span class="goal-desc" data-i18n="config.goals.hypertrophy.desc">TUT • Volume alto</span>
                                </div>
                            </label>
                            <label class="goal-option">
                                <input type="radio" name="goal" value="fatloss">
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M17,8C8,10 5.9,16.17 3.82,21.34L5.71,22L6.66,19.7C7.14,19.87 7.64,20 8,20C19,20 22,3 22,3C21,5 14,5.25 9,6.25C4,7.25 2,11.5 2,13.5C2,15.5 3.75,17.25 3.75,17.25C7,8 17,8 17,8Z"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.fatloss.name">Dimagrimento</span>
                                    <span class="goal-desc" data-i18n="config.goals.fatloss.desc">Condizionamento metabolico</span>
                                </div>
                            </label>
                            <label class="goal-option">
                                <input type="radio" name="goal" value="endurance">
                                <div class="goal-card">
                                    <svg viewBox="0 0 24 24"><path d="M13.5,5.5C14.59,5.5 15.5,4.58 15.5,3.5C15.5,2.38 14.59,1.5 13.5,1.5C12.39,1.5 11.5,2.38 11.5,3.5C11.5,4.58 12.39,5.5 13.5,5.5M9.89,19.38L10.89,15L13,17V23H15V15.5L12.89,13.5L13.5,10.5C14.79,12 16.79,13 19,13V11C17.09,11 15.5,10 14.69,8.58L13.69,7C13.29,6.38 12.69,6 12,6C11.69,6 11.5,6.08 11.19,6.19L6,8.28V13H8V9.58L9.79,8.88L8.19,17L3.29,16L2.89,18L9.89,19.38Z"/></svg>
                                    <span class="goal-name" data-i18n="config.goals.endurance.name">Endurance</span>
                                    <span class="goal-desc" data-i18n="config.goals.endurance.desc">Capacità di lavoro</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Experience Level -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="config.level">Livello Esperienza</label>
                        <div class="level-selector">
                            <label class="level-option">
                                <input type="radio" name="level" value="beginner">
                                <div class="level-btn">
                                    <div class="rank" data-i18n="config.levels.beginner.name">PRINCIPIANTE</div>
                                    <div class="time" data-i18n="config.levels.beginner.desc">0-6 mesi</div>
                                </div>
                            </label>
                            <label class="level-option">
                                <input type="radio" name="level" value="intermediate" checked>
                                <div class="level-btn">
                                    <div class="rank" data-i18n="config.levels.intermediate.name">INTERMEDIO</div>
                                    <div class="time" data-i18n="config.levels.intermediate.desc">6-24 mesi</div>
                                </div>
                            </label>
                            <label class="level-option">
                                <input type="radio" name="level" value="advanced">
                                <div class="level-btn">
                                    <div class="rank" data-i18n="config.levels.advanced.name">AVANZATO</div>
                                    <div class="time" data-i18n="config.levels.advanced.desc">2+ anni</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Frequency -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="config.frequency">Sessioni/Settimana</label>
                        <select class="tactical-select" id="frequency">
                            <option value="2">2 Sessioni / Settimana</option>
                            <option value="3" selected>3 Sessioni / Settimana</option>
                            <option value="4">4 Sessioni / Settimana</option>
                            <option value="5">5 Sessioni / Settimana</option>
                        </select>
                    </div>

                    <!-- Duration -->
                    <div class="form-group">
                        <label class="form-label"><span data-i18n="config.duration">Durata Sessione</span>: <span id="durationValue" class="current">45</span> <span data-i18n="config.minutes">Min</span></label>
                        <div class="range-container">
                            <input type="range" class="range-slider" id="duration" min="30" max="75" value="45" step="5">
                            <div class="range-value">
                                <span>30</span>
                                <span>75</span>
                            </div>
                        </div>
                    </div>

                    <!-- Program Length -->
                    <div class="form-group">
                        <label class="form-label" data-i18n="config.weeks">Durata Programma</label>
                        <select class="tactical-select" id="programLength">
                            <option value="4">4 Settimane</option>
                            <option value="6" selected>6 Settimane</option>
                            <option value="8">8 Settimane</option>
                            <option value="12">12 Settimane</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Exercise Selection -->
            <div class="panel exercise-panel">
                <div class="panel-header">
                    <div class="panel-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M19,19H5V5H19M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M13.96,12.29L11.21,15.83L9.25,13.47L6.5,17H17.5L13.96,12.29Z"/></svg>
                    </div>
                    <h2 data-i18n="exercises.title">Selezione Esercizi</h2>
                    <span class="designation">SELECT-002</span>
                </div>
                <div class="panel-body">
                    <div class="selection-count">
                        <div class="number" id="selectedCount">0</div>
                        <div class="text" data-i18n="exercises.selected">selezionati</div>
                    </div>

                    <!-- Swings -->
                    <div class="exercise-category" data-category="swings">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.swings">SWING</h3>
                            <span class="toggle-all" onclick="toggleCategory('swings')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-twohand-swing" name="exercise" value="Two-Hand Swing" data-pattern="hinge" data-double="false" checked>
                                <label for="ex-twohand-swing">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Two-Hand Swing</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-onehand-swing" name="exercise" value="One-Hand Swing" data-pattern="hinge" data-double="false">
                                <label for="ex-onehand-swing">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">One-Hand Swing</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-h2h-swing" name="exercise" value="Hand-to-Hand Swing" data-pattern="hinge" data-double="false">
                                <label for="ex-h2h-swing">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Hand-to-Hand Swing</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-double-swing" name="exercise" value="Double Swing" data-pattern="hinge" data-double="true">
                                <label for="ex-double-swing">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Double Swing</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Cleans -->
                    <div class="exercise-category" data-category="cleans">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.cleans">CLEAN</h3>
                            <span class="toggle-all" onclick="toggleCategory('cleans')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-clean" name="exercise" value="Clean" data-pattern="hinge" data-double="false">
                                <label for="ex-clean">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Clean</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-double-clean" name="exercise" value="Double Clean" data-pattern="hinge" data-double="true">
                                <label for="ex-double-clean">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Double Clean</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-hang-clean" name="exercise" value="Hang Clean" data-pattern="hinge" data-double="false">
                                <label for="ex-hang-clean">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Hang Clean</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Snatches -->
                    <div class="exercise-category" data-category="snatches">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.snatches">SNATCH</h3>
                            <span class="toggle-all" onclick="toggleCategory('snatches')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-snatch" name="exercise" value="Snatch" data-pattern="hinge" data-double="false">
                                <label for="ex-snatch">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Snatch</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-dead-snatch" name="exercise" value="Dead Snatch" data-pattern="hinge" data-double="false">
                                <label for="ex-dead-snatch">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Dead Snatch</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-jerk" name="exercise" value="Jerk" data-pattern="push" data-double="false">
                                <label for="ex-jerk">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Jerk</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-high-pull" name="exercise" value="High Pull" data-pattern="hinge" data-double="false">
                                <label for="ex-high-pull">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">High Pull</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Presses -->
                    <div class="exercise-category" data-category="presses">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.presses">PRESS</h3>
                            <span class="toggle-all" onclick="toggleCategory('presses')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-military-press" name="exercise" value="Military Press" data-pattern="push" data-double="false" checked>
                                <label for="ex-military-press">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Military Press</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-push-press" name="exercise" value="Push Press" data-pattern="push" data-double="false">
                                <label for="ex-push-press">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Push Press</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-floor-press" name="exercise" value="Floor Press" data-pattern="push" data-double="false">
                                <label for="ex-floor-press">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Floor Press</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-seesaw-press" name="exercise" value="See-Saw Press" data-pattern="push" data-double="true">
                                <label for="ex-seesaw-press">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">See-Saw Press</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-double-press" name="exercise" value="Double Press" data-pattern="push" data-double="true">
                                <label for="ex-double-press">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Double Press</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Squats -->
                    <div class="exercise-category" data-category="squats">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.squats">SQUAT</h3>
                            <span class="toggle-all" onclick="toggleCategory('squats')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-goblet-squat" name="exercise" value="Goblet Squat" data-pattern="squat" data-double="false" checked>
                                <label for="ex-goblet-squat">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Goblet Squat</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-jump-squat" name="exercise" value="Jump Squat" data-pattern="squat" data-double="false">
                                <label for="ex-jump-squat">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Jump Squat</span>
                                    <span class="ballistic-tag">BALISTICO</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-somersault-squat" name="exercise" value="Somersault Squat" data-pattern="squat" data-double="false">
                                <label for="ex-somersault-squat">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Somersault Squat</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-double-front-squat" name="exercise" value="Double Front Squat" data-pattern="squat" data-double="true">
                                <label for="ex-double-front-squat">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Double Front Squat</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Lunges -->
                    <div class="exercise-category" data-category="lunges">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.lunges">AFFONDI</h3>
                            <span class="toggle-all" onclick="toggleCategory('lunges')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-rack-lunge" name="exercise" value="Rack Lunge" data-pattern="lunge" data-double="false">
                                <label for="ex-rack-lunge">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Rack Lunge</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-reverse-lunge" name="exercise" value="Reverse Lunge" data-pattern="lunge" data-double="false">
                                <label for="ex-reverse-lunge">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Reverse Lunge</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-walking-lunge" name="exercise" value="Walking Lunge" data-pattern="lunge" data-double="false">
                                <label for="ex-walking-lunge">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Walking Lunge</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-lateral-lunge" name="exercise" value="Lateral Lunge" data-pattern="lunge" data-double="false">
                                <label for="ex-lateral-lunge">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Lateral Lunge</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Rows -->
                    <div class="exercise-category" data-category="rows">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.rows">TIRATE</h3>
                            <span class="toggle-all" onclick="toggleCategory('rows')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-bent-row" name="exercise" value="Bent Over Row" data-pattern="pull" data-double="false" checked>
                                <label for="ex-bent-row">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Bent Over Row</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-single-row" name="exercise" value="Single Arm Row" data-pattern="pull" data-double="false">
                                <label for="ex-single-row">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Single Arm Row</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-gorilla-row" name="exercise" value="Gorilla Row" data-pattern="pull" data-double="true">
                                <label for="ex-gorilla-row">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Gorilla Row</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-renegade-row" name="exercise" value="Renegade Row" data-pattern="pull" data-double="true">
                                <label for="ex-renegade-row">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Renegade Row</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hinges -->
                    <div class="exercise-category" data-category="hinges">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.hinges">HINGE</h3>
                            <span class="toggle-all" onclick="toggleCategory('hinges')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-deadlift" name="exercise" value="Deadlift" data-pattern="hinge" data-double="false">
                                <label for="ex-deadlift">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Deadlift</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-sldl" name="exercise" value="Single Leg Deadlift" data-pattern="hinge" data-double="false">
                                <label for="ex-sldl">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Single Leg Deadlift</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-sumo-dl" name="exercise" value="Sumo Deadlift" data-pattern="hinge" data-double="false">
                                <label for="ex-sumo-dl">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Sumo Deadlift</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-good-morning" name="exercise" value="Good Morning" data-pattern="hinge" data-double="false">
                                <label for="ex-good-morning">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Good Morning</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Carries -->
                    <div class="exercise-category" data-category="carries">
                        <div class="category-header">
                            <h3 data-i18n="exercises.categories.carries">CARRY</h3>
                            <span class="toggle-all" onclick="toggleCategory('carries')" data-i18n="exercises.selectAll">Seleziona Tutti</span>
                        </div>
                        <div class="exercise-list-select">
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-farmers-carry" name="exercise" value="Farmers Carry" data-pattern="carry" data-double="true">
                                <label for="ex-farmers-carry">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Farmers Carry</span>
                                    <span class="double-tag">2KB</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-suitcase-carry" name="exercise" value="Suitcase Carry" data-pattern="carry" data-double="false">
                                <label for="ex-suitcase-carry">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Suitcase Carry</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-rack-carry" name="exercise" value="Rack Carry" data-pattern="carry" data-double="false">
                                <label for="ex-rack-carry">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Rack Carry</span>
                                </label>
                            </div>
                            <div class="exercise-checkbox">
                                <input type="checkbox" id="ex-overhead-carry" name="exercise" value="Overhead Carry" data-pattern="carry" data-double="false">
                                <label for="ex-overhead-carry">
                                    <span class="check-icon"></span>
                                    <span class="ex-name">Overhead Carry</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="selection-warning" id="selectionWarning" style="display: none;">
                        <p data-i18n="exercises.minimum">⚠️ Minimo 4 esercizi richiesti</p>
                    </div>

                    <button class="generate-btn" id="generateBtn" data-i18n="generate">
                        GENERA PROTOCOLLO
                    </button>
                </div>
            </div>

            <!-- Panel 3: Program Output -->
            <div class="panel program-panel">
                <div class="panel-header">
                    <div class="panel-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M7,7H17V5H19V19H5V5H7V7Z"/></svg>
                    </div>
                    <h2 data-i18n="program.title">Programma di Allenamento</h2>
                    <span class="designation">OUTPUT-003</span>
                </div>
                <div class="panel-body">
                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <p data-i18n="generating">ELABORAZIONE PROTOCOLLO...</p>
                    </div>

                    <div class="placeholder-state" id="placeholder">
                        <svg viewBox="0 0 24 24"><path d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3"/></svg>
                        <h3 data-i18n="placeholder.title">IN ATTESA</h3>
                        <p data-i18n="placeholder.desc">Configura i parametri, seleziona gli esercizi e genera il tuo protocollo</p>
                    </div>

                    <div class="program-output" id="programOutput"></div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p data-i18n="footer">IRON PROTOCOL™ | CENTRO COMANDO KETTLEBELL | PROGRAMMAZIONE BASATA SU EVIDENZE</p>
        </footer>
    </div>

    <!-- Mobile Sticky Generate Button -->
    <button class="mobile-generate-btn" id="mobileGenerateBtn" data-i18n="generate">
        <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"/></svg>
        GENERA PROTOCOLLO
    </button>

    <div class="timer-overlay" id="timerOverlay">
        <div class="timer-container">
            <button class="timer-btn close" id="closeTimer">✕</button>
            <div class="timer-exercise" id="timerExercise" data-i18n="timer.rest">PERIODO DI RECUPERO</div>
            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="timer-controls">
                <button class="timer-btn start" id="startTimer" data-i18n="timer.start">AVVIA</button>
                <button class="timer-btn" id="resetTimer" data-i18n="timer.reset">RESET</button>
            </div>
        </div>
    </div>

    <!-- Edit Exercise Modal -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 data-i18n="edit.title">MODIFICA ESERCIZIO</h3>
                <button class="edit-modal-close" id="closeEditModal">✕</button>
            </div>
            <div class="edit-modal-body">
                <div class="edit-exercise-name" id="editExerciseName">-</div>
                <div class="edit-exercise-pattern" id="editExercisePattern">-</div>
                
                <div class="edit-method-info" id="editMethodInfo">
                    Modifica i parametri dell'esercizio.
                </div>

                <!-- Ladder fields -->
                <div id="editLadderFields" style="display:none;">
                    <div class="edit-field">
                        <label data-i18n="edit.numLadders">Numero Ladders</label>
                        <input type="number" id="editNumLadders" min="1" max="10" value="3">
                        <div class="edit-field-hint" data-i18n="edit.numLaddersHint">Quante ladders eseguire</div>
                    </div>
                    <div class="edit-field">
                        <label data-i18n="edit.rungs">Rungs (separati da -)</label>
                        <input type="text" id="editLadderRungs" placeholder="1-2-3-4" value="1-2-3-4">
                        <div class="edit-field-hint" data-i18n="edit.rungsHint">Es: 1-2-3-4 oppure 1-2-3</div>
                    </div>
                </div>

                <!-- Cluster fields -->
                <div id="editClusterFields" style="display:none;">
                    <div class="edit-field">
                        <label data-i18n="edit.numClusters">Numero Clusters</label>
                        <input type="number" id="editNumClusters" min="1" max="10" value="4">
                        <div class="edit-field-hint" data-i18n="edit.numClustersHint">Quanti cluster eseguire</div>
                    </div>
                    <div class="edit-field">
                        <label data-i18n="edit.breakdown">Breakdown (separati da +)</label>
                        <input type="text" id="editClusterBreakdown" placeholder="2+2+2" value="2+2+2">
                        <div class="edit-field-hint" data-i18n="edit.breakdownHint">Es: 2+2+2 oppure 3+2+1</div>
                    </div>
                </div>

                <!-- Straight sets fields -->
                <div id="editStraightFields" style="display:none;">
                    <div class="edit-field-row">
                        <div class="edit-field">
                            <label data-i18n="edit.sets">Serie</label>
                            <input type="number" id="editSets" min="1" max="10" value="3">
                        </div>
                        <div class="edit-field">
                            <label data-i18n="edit.reps">Ripetizioni</label>
                            <input type="text" id="editReps" placeholder="8-12" value="8-12">
                            <div class="edit-field-hint" data-i18n="edit.repsHint">Range o numero fisso</div>
                        </div>
                    </div>
                </div>

                <!-- Common fields -->
                <div class="edit-field">
                    <label data-i18n="edit.notes">Note (opzionale)</label>
                    <input type="text" id="editNotes" data-i18n-placeholder="edit.notesPlaceholder" placeholder="Es: focus sulla tecnica">
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-btn cancel" id="cancelEdit" data-i18n="edit.cancel">ANNULLA</button>
                <button class="edit-btn save" id="saveEdit" data-i18n="edit.save">SALVA</button>
            </div>
        </div>
    </div>

    <!-- Propagation Modal -->
    <div class="edit-modal" id="propagateModal">
        <div class="edit-modal-content propagate-content">
            <div class="edit-modal-header propagate-header">
                <h3 data-i18n="propagate.title">🔄 PROPAGA MODIFICHE</h3>
                <button class="edit-modal-close" id="closePropagateModal">✕</button>
            </div>
            <div class="edit-modal-body">
                <div class="propagate-question" data-i18n="propagate.question">
                    Vuoi applicare questa modifica anche ad altre settimane?
                </div>
                <div class="propagate-exercise-info" id="propagateExerciseInfo">
                    <strong id="propagateExerciseName">-</strong>
                    <span id="propagateChangesSummary">-</span>
                </div>
                
                <div class="propagate-options">
                    <label class="propagate-option">
                        <input type="radio" name="propagate" value="this" checked>
                        <div class="propagate-option-content">
                            <span class="propagate-option-title" data-i18n="propagate.thisWeek">Solo questa settimana</span>
                            <span class="propagate-option-desc"><span data-i18n="propagate.thisWeekDesc">La modifica sarà applicata solo a Week</span> <span id="propCurrentWeek">1</span></span>
                        </div>
                    </label>
                    
                    <label class="propagate-option">
                        <input type="radio" name="propagate" value="all">
                        <div class="propagate-option-content">
                            <span class="propagate-option-title" data-i18n="propagate.allWeeks">Tutte le settimane</span>
                            <span class="propagate-option-desc"><span data-i18n="propagate.allWeeksDesc">Applica a tutte le settimane del programma</span> (<span id="propTotalWeeks">6</span>)</span>
                        </div>
                    </label>
                    
                    <label class="propagate-option">
                        <input type="radio" name="propagate" value="range">
                        <div class="propagate-option-content">
                            <span class="propagate-option-title" data-i18n="propagate.range">Range personalizzato</span>
                            <span class="propagate-option-desc" data-i18n="propagate.rangeDesc">Scegli le settimane specifiche</span>
                        </div>
                    </label>
                    
                    <div class="propagate-range" id="propagateRangeSelector" style="display:none;">
                        <div class="range-inputs">
                            <label>
                                <span data-i18n="propagate.fromWeek">Da settimana:</span>
                                <select id="propRangeStart"></select>
                            </label>
                            <label>
                                <span data-i18n="propagate.toWeek">A settimana:</span>
                                <select id="propRangeEnd"></select>
                            </label>
                        </div>
                    </div>
                    
                    <label class="propagate-option">
                        <input type="radio" name="propagate" value="same-day">
                        <div class="propagate-option-content">
                            <span class="propagate-option-title" data-i18n="propagate.sameDay">Stesso giorno, tutte le settimane</span>
                            <span class="propagate-option-desc"><span data-i18n="propagate.sameDayDesc">Applica solo al Day</span> <span id="propCurrentDay">1</span></span>
                        </div>
                    </label>
                </div>
                
                <div class="propagate-preview" id="propagatePreview">
                    <div class="preview-label" data-i18n="propagate.preview">Anteprima: le modifiche saranno applicate a:</div>
                    <div class="preview-weeks" id="previewWeeks"></div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-btn cancel" id="cancelPropagate" data-i18n="edit.cancel">ANNULLA</button>
                <button class="edit-btn save" id="confirmPropagate" data-i18n="propagate.apply">APPLICA</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            programsGenerated: parseInt(localStorage.getItem('programsGenerated') || '0'),
            timerInterval: null,
            timerSeconds: 0,
            timerRunning: false,
            selectedPreset: null,
            currentProgram: null,
            exerciseEdits: {},  // Store edits by week-day-exerciseIndex
            currentEditTarget: null,  // { week, day, exerciseIndex, exerciseData }
            pendingEdit: null,  // Stores the edit before propagation decision
            propagatedEdits: new Set(),  // Track which edits were propagated
            currentLang: localStorage.getItem('ironProtocolLang') || 'it'  // Default Italian
        };

        // Translations
        const translations = {
            it: {
                // Header
                subtitle: 'Centro Comando Allenamento Kettlebell',
                stats: {
                    generated: 'Programmi Generati',
                    evidenceBased: 'Basato su Evidenze'
                },
                // Presets
                presets: {
                    title: 'PROGRAMMI PRESET',
                    description: 'Seleziona un preset per avere subito un programma completo di 12 settimane. Puoi modificarlo successivamente.',
                    divider: 'OPPURE CONFIGURA MANUALMENTE',
                    select: 'SELEZIONA',
                    strength: {
                        badge: 'FORZA',
                        name: 'Iron Strength',
                        desc: 'Costruisci forza massimale con ladders e periodizzazione intelligente',
                        features: ['12 settimane • 3x/settimana', 'Ladders su 2 esercizi primari', 'Wave loading + intensificazione']
                    },
                    power: {
                        badge: 'POWER',
                        name: 'Explosive Power',
                        desc: 'Sviluppa potenza esplosiva con clusters su esercizi balistici',
                        features: ['12 settimane • 3x/settimana', 'Clusters su swing/snatch/clean', 'Focus su velocità e qualità']
                    },
                    fitness: {
                        badge: 'FITNESS',
                        name: 'Total Fitness',
                        desc: 'Programma bilanciato per fitness generale e condizionamento',
                        features: ['12 settimane • 3x/settimana • 45 min', 'Volume controllato, tempo realistico', 'Finisher adattivi']
                    },
                    hypertrophy: {
                        badge: 'MASSA',
                        name: 'Muscle Builder',
                        desc: 'Massimizza l\'ipertrofia con tempo controllato e volume progressivo',
                        features: ['12 settimane • 4x/settimana', 'Tempo 3-1-2-0 per TUT', 'Double progression']
                    }
                },
                // Config Panel
                config: {
                    title: 'Parametri Allenamento',
                    equipment: 'Attrezzatura',
                    singleKB: 'Singolo KB',
                    singleKBDesc: 'Un kettlebell',
                    doubleKB: 'Doppio KB',
                    doubleKBDesc: 'Coppia di kettlebell',
                    goal: 'Obiettivo Primario',
                    goals: {
                        general: { name: 'Fitness Generale', desc: 'Condizionamento completo' },
                        strength: { name: 'Forza Massimale', desc: 'Ladders • Basse ripetizioni' },
                        power: { name: 'Potenza', desc: 'Clusters • Esplosività' },
                        hypertrophy: { name: 'Ipertrofia', desc: 'TUT • Volume alto' },
                        fatloss: { name: 'Dimagrimento', desc: 'Condizionamento metabolico' },
                        endurance: { name: 'Endurance', desc: 'Capacità di lavoro' }
                    },
                    level: 'Livello Esperienza',
                    levels: {
                        beginner: { name: 'Principiante', desc: '0-6 mesi' },
                        intermediate: { name: 'Intermedio', desc: '6-24 mesi' },
                        advanced: { name: 'Avanzato', desc: '2+ anni' }
                    },
                    frequency: 'Sessioni/Settimana',
                    duration: 'Durata Sessione',
                    minutes: 'Min',
                    weeks: 'Durata Programma',
                    weeksLabel: 'Settimane'
                },
                // Exercise Panel
                exercises: {
                    title: 'Selezione Esercizi',
                    selected: 'selezionati',
                    minimum: 'Minimo 4 esercizi richiesti',
                    selectAll: 'Seleziona Tutti',
                    categories: {
                        swings: 'SWING',
                        cleans: 'CLEAN',
                        snatches: 'SNATCH',
                        presses: 'PRESS',
                        squats: 'SQUAT',
                        lunges: 'AFFONDI',
                        hinges: 'HINGE',
                        rows: 'TIRATE',
                        carries: 'CARRY'
                    }
                },
                // Generate Button
                generate: 'GENERA PROTOCOLLO',
                generating: 'Elaborazione...',
                // Program Output
                program: {
                    title: 'Programma di Allenamento',
                    weeks: 'Settimane',
                    perWeek: 'Per Settimana',
                    minSession: 'Min/Sessione',
                    intensity: 'Intensità',
                    progression: 'PROGRESSIONE',
                    guidelines: 'LINEE GUIDA ALLENAMENTO',
                    autoregulation: 'AUTOREGOLAZIONE CARICO',
                    print: 'STAMPA',
                    regenerate: 'RIGENERA',
                    week: 'SETTIMANA',
                    day: 'GIORNO',
                    deload: 'DELOAD',
                    accessory: 'ACCESSORI',
                    supplemental: 'Lavoro Supplementare',
                    finisher: 'FINISHER',
                    optional: 'OPZIONALE',
                    lightFinisher: 'Finisher Leggero',
                    easyMovement: 'Movimento Facile',
                    easyMovementDesc: '5-10 min di lavoro leggero o salta completamente. Focus sul recupero.',
                    pattern: 'pattern',
                    total: 'Totale',
                    reps: 'reps',
                    rest: 'Recupero',
                    rungs: 'Rungs',
                    ladders: 'Ladders',
                    intra: 'Intra',
                    inter: 'Inter',
                    tempo: 'Tempo'
                },
                // Session Names
                sessions: {
                    'HINGE FOCUS': 'FOCUS HINGE',
                    'SQUAT FOCUS': 'FOCUS SQUAT',
                    'PUSH FOCUS': 'FOCUS PUSH',
                    'PULL FOCUS': 'FOCUS PULL',
                    'LOWER BODY': 'LOWER BODY',
                    'UPPER BODY': 'UPPER BODY',
                    'FULL BODY': 'FULL BODY'
                },
                // Methods
                methods: {
                    ladder: 'LADDER',
                    cluster: 'CLUSTER',
                    straight: 'SERIE CLASSICHE',
                    trainingMethod: 'METODO DI ALLENAMENTO',
                    example: 'Esempio',
                    note: 'Nota',
                    ladderExplanation: 'Le Ladders sono una tecnica potente per costruire forza dove "sali" le ripetizioni ad ogni rung, accumulando volume senza cedimento.',
                    ladderExample: 'Una ladder <code>1-2-3</code> significa: 1 rep → recupero 30-60s → 2 reps → recupero 30-60s → 3 reps → recupero 2-3 min → ripeti ladder',
                    clusterExplanation: 'I Clusters suddividono le serie in mini-serie con brevi pause intra-set, mantenendo la potenza evitando l\'accumulo di fatica.',
                    clusterExample: '<code>2+2+2</code> significa: 2 reps → pausa 15s → 2 reps → pausa 15s → 2 reps → recupero 2-3 min → prossimo cluster',
                    clusterNote: 'I cluster sono applicati <strong>solo</strong> agli esercizi balistici (Swing, Snatch, Clean, Jerk, Push Press). Gli altri esercizi usano serie classiche.'
                },
                // H/L/M
                hlm: {
                    title: 'Schema Heavy / Light / Medium',
                    description: 'Le sedute sono organizzate con intensità variabile per ottimizzare recupero e adattamento:',
                    heavy: 'HEAVY',
                    light: 'LIGHT',
                    medium: 'MEDIUM',
                    heavyDesc: 'Volume pieno, carichi più alti. Nessun finisher per Strength/Power.',
                    lightDesc: 'Volume ridotto (~70%), focus su tecnica e velocità. Nessun finisher.',
                    mediumDesc: 'Volume moderato (~85%), finisher consentito.'
                },
                // Edit Modal
                edit: {
                    title: 'MODIFICA ESERCIZIO',
                    info: 'Modifica i parametri dell\'esercizio.',
                    numLadders: 'Numero Ladders',
                    numLaddersHint: 'Quante ladders eseguire',
                    rungs: 'Rungs (separati da -)',
                    rungsHint: 'Es: 1-2-3-4 oppure 1-2-3',
                    numClusters: 'Numero Clusters',
                    numClustersHint: 'Quanti cluster eseguire',
                    breakdown: 'Breakdown (separati da +)',
                    breakdownHint: 'Es: 2+2+2 oppure 3+2+1',
                    sets: 'Serie',
                    reps: 'Ripetizioni',
                    repsHint: 'Range o numero fisso',
                    notes: 'Note (opzionale)',
                    notesPlaceholder: 'Es: focus sulla tecnica',
                    cancel: 'ANNULLA',
                    save: 'SALVA',
                    ladderInfo: 'Modifica il numero di ladders e le rungs. Aumenta le rungs per più volume, riducile per più intensità.',
                    clusterInfo: 'Modifica il numero di cluster e il breakdown. Mantieni le pause intra-cluster brevi per preservare la potenza.',
                    straightInfo: 'Modifica sets e reps. Per l\'ipertrofia usa 8-12 reps, per la forza 3-6 reps.'
                },
                // Propagate Modal
                propagate: {
                    title: '🔄 PROPAGA MODIFICHE',
                    question: 'Vuoi applicare questa modifica anche ad altre settimane?',
                    thisWeek: 'Solo questa settimana',
                    thisWeekDesc: 'La modifica sarà applicata solo a Week',
                    allWeeks: 'Tutte le settimane',
                    allWeeksDesc: 'Applica a tutte le settimane del programma',
                    range: 'Range personalizzato',
                    rangeDesc: 'Scegli le settimane specifiche',
                    sameDay: 'Stesso giorno, tutte le settimane',
                    sameDayDesc: 'Applica solo al Day',
                    fromWeek: 'Da settimana:',
                    toWeek: 'A settimana:',
                    preview: 'Anteprima: le modifiche saranno applicate a:',
                    apply: 'APPLICA'
                },
                // Warnings
                warnings: {
                    title: '⚠️ ATTENZIONE',
                    noPull: 'Nessun esercizio di TIRATA (row) selezionato. Questo può creare squilibri muscolari.',
                    noHinge: 'Nessun esercizio HINGE (deadlift/swing) selezionato.',
                    noSquat: 'Nessun esercizio SQUAT selezionato.',
                    powerNoBallistic: 'Per l\'obiettivo POWER è consigliato includere esercizi balistici (Swing, Snatch, Clean, Jerk, Push Press) per sfruttare il metodo Cluster.',
                    beginnerAdvanced: 'Per i principianti è consigliato iniziare con esercizi base prima di passare a quelli avanzati.',
                    proceed: 'PROCEDI COMUNQUE',
                    goBack: 'TORNA ALLA SELEZIONE'
                },
                // Toasts
                toasts: {
                    presetApplied: 'Preset applicato! Puoi modificarlo prima di generare.',
                    editSaved: 'Modifica salvata!',
                    editApplied: 'Modifica applicata a {count} esercizi!',
                    minExercises: 'Seleziona almeno 4 esercizi per generare il programma.'
                },
                // Timer
                timer: {
                    rest: 'PERIODO DI RECUPERO',
                    start: 'AVVIA',
                    reset: 'RESET'
                },
                // Phases
                phases: {
                    accumulation: 'Accumulo',
                    intensification: 'Intensificazione',
                    realization: 'Realizzazione',
                    deload: 'Deload'
                },
                // Load guidance
                loadGuidance: {
                    increase: '↑ SALI DI KB',
                    deload: 'Stesso KB di W1, RPE 6-7'
                },
                // Badges
                badges: {
                    modified: 'MODIFICATO',
                    propagated: 'PROPAGATO'
                },
                // Placeholder
                placeholder: {
                    title: 'IN ATTESA',
                    desc: 'Configura i parametri, seleziona gli esercizi e genera il tuo protocollo'
                },
                // Footer
                footer: 'IRON PROTOCOL™ | CENTRO COMANDO KETTLEBELL | PROGRAMMAZIONE BASATA SU EVIDENZE'
            },
            en: {
                // Header
                subtitle: 'Kettlebell Training Command Center',
                stats: {
                    generated: 'Programs Generated',
                    evidenceBased: 'Evidence-Based'
                },
                // Presets
                presets: {
                    title: 'PRESET PROGRAMS',
                    description: 'Select a preset to get a complete 12-week program instantly. You can modify it afterwards.',
                    divider: 'OR CONFIGURE MANUALLY',
                    select: 'SELECT',
                    strength: {
                        badge: 'STRENGTH',
                        name: 'Iron Strength',
                        desc: 'Build maximal strength with ladders and intelligent periodization',
                        features: ['12 weeks • 3x/week', 'Ladders on 2 primary exercises', 'Wave loading + intensification']
                    },
                    power: {
                        badge: 'POWER',
                        name: 'Explosive Power',
                        desc: 'Develop explosive power with clusters on ballistic exercises',
                        features: ['12 weeks • 3x/week', 'Clusters on swing/snatch/clean', 'Focus on speed and quality']
                    },
                    fitness: {
                        badge: 'FITNESS',
                        name: 'Total Fitness',
                        desc: 'Balanced program for general fitness and conditioning',
                        features: ['12 weeks • 3x/week • 45 min', 'Controlled volume, realistic timing', 'Adaptive finishers']
                    },
                    hypertrophy: {
                        badge: 'HYPERTROPHY',
                        name: 'Muscle Builder',
                        desc: 'Maximize hypertrophy with controlled tempo and progressive volume',
                        features: ['12 weeks • 4x/week', 'Tempo 3-1-2-0 for TUT', 'Double progression']
                    }
                },
                // Config Panel
                config: {
                    title: 'Training Parameters',
                    equipment: 'Equipment',
                    singleKB: 'Single KB',
                    singleKBDesc: 'One kettlebell',
                    doubleKB: 'Double KB',
                    doubleKBDesc: 'Pair of kettlebells',
                    goal: 'Primary Objective',
                    goals: {
                        general: { name: 'General Fitness', desc: 'All-round conditioning' },
                        strength: { name: 'Max Strength', desc: 'Ladders • Low reps' },
                        power: { name: 'Power', desc: 'Clusters • Explosive' },
                        hypertrophy: { name: 'Hypertrophy', desc: 'TUT • High volume' },
                        fatloss: { name: 'Fat Loss', desc: 'Metabolic conditioning' },
                        endurance: { name: 'Endurance', desc: 'Work capacity' }
                    },
                    level: 'Experience Level',
                    levels: {
                        beginner: { name: 'Beginner', desc: '0-6 months' },
                        intermediate: { name: 'Intermediate', desc: '6-24 months' },
                        advanced: { name: 'Advanced', desc: '2+ years' }
                    },
                    frequency: 'Sessions/Week',
                    duration: 'Session Duration',
                    minutes: 'Min',
                    weeks: 'Program Length',
                    weeksLabel: 'Weeks'
                },
                // Exercise Panel
                exercises: {
                    title: 'Exercise Selection',
                    selected: 'selected',
                    minimum: 'Minimum 4 exercises required',
                    selectAll: 'Select All',
                    categories: {
                        swings: 'SWINGS',
                        cleans: 'CLEANS',
                        snatches: 'SNATCHES',
                        presses: 'PRESSES',
                        squats: 'SQUATS',
                        lunges: 'LUNGES',
                        hinges: 'HINGES',
                        rows: 'ROWS',
                        carries: 'CARRIES'
                    }
                },
                // Generate Button
                generate: 'GENERATE PROTOCOL',
                generating: 'Processing...',
                // Program Output
                program: {
                    title: 'Training Program',
                    weeks: 'Weeks',
                    perWeek: 'Per Week',
                    minSession: 'Min/Session',
                    intensity: 'Intensity',
                    progression: 'PROGRESSION',
                    guidelines: 'TRAINING GUIDELINES',
                    autoregulation: 'LOAD AUTOREGULATION',
                    print: 'PRINT',
                    regenerate: 'REGENERATE',
                    week: 'WEEK',
                    day: 'DAY',
                    deload: 'DELOAD',
                    accessory: 'ACCESSORY',
                    supplemental: 'Supplemental Work',
                    finisher: 'FINISHER',
                    optional: 'OPTIONAL',
                    lightFinisher: 'Light Finisher',
                    easyMovement: 'Easy Movement',
                    easyMovementDesc: '5-10 min light work or skip entirely. Focus on recovery.',
                    pattern: 'pattern',
                    total: 'Total',
                    reps: 'reps',
                    rest: 'Rest',
                    rungs: 'Rungs',
                    ladders: 'Ladders',
                    intra: 'Intra',
                    inter: 'Inter',
                    tempo: 'Tempo'
                },
                // Session Names
                sessions: {
                    'HINGE FOCUS': 'HINGE FOCUS',
                    'SQUAT FOCUS': 'SQUAT FOCUS',
                    'PUSH FOCUS': 'PUSH FOCUS',
                    'PULL FOCUS': 'PULL FOCUS',
                    'LOWER BODY': 'LOWER BODY',
                    'UPPER BODY': 'UPPER BODY',
                    'FULL BODY': 'FULL BODY'
                },
                // Methods
                methods: {
                    ladder: 'LADDER',
                    cluster: 'CLUSTER',
                    straight: 'STRAIGHT SETS',
                    trainingMethod: 'TRAINING METHOD',
                    example: 'Example',
                    note: 'Note',
                    ladderExplanation: 'Ladders are a powerful strength-building technique where you "climb" reps each rung, accumulating volume without grinding.',
                    ladderExample: 'A <code>1-2-3</code> ladder means: 1 rep → rest 30-60s → 2 reps → rest 30-60s → 3 reps → rest 2-3 min → repeat ladder',
                    clusterExplanation: 'Clusters break sets into mini-sets with brief intra-set rest, maintaining power output by preventing fatigue accumulation.',
                    clusterExample: '<code>2+2+2</code> means: 2 reps → rest 15s → 2 reps → rest 15s → 2 reps → rest 2-3 min → next cluster',
                    clusterNote: 'Clusters are applied <strong>only</strong> to ballistic exercises (Swing, Snatch, Clean, Jerk, Push Press). Other exercises use straight sets.'
                },
                // H/L/M
                hlm: {
                    title: 'Heavy / Light / Medium Schema',
                    description: 'Sessions are organized with variable intensity to optimize recovery and adaptation:',
                    heavy: 'HEAVY',
                    light: 'LIGHT',
                    medium: 'MEDIUM',
                    heavyDesc: 'Full volume, higher loads. No finisher for Strength/Power.',
                    lightDesc: 'Reduced volume (~70%), focus on technique and speed. No finisher.',
                    mediumDesc: 'Moderate volume (~85%), finisher allowed.'
                },
                // Edit Modal
                edit: {
                    title: 'EDIT EXERCISE',
                    info: 'Modify the exercise parameters.',
                    numLadders: 'Number of Ladders',
                    numLaddersHint: 'How many ladders to perform',
                    rungs: 'Rungs (separated by -)',
                    rungsHint: 'E.g.: 1-2-3-4 or 1-2-3',
                    numClusters: 'Number of Clusters',
                    numClustersHint: 'How many clusters to perform',
                    breakdown: 'Breakdown (separated by +)',
                    breakdownHint: 'E.g.: 2+2+2 or 3+2+1',
                    sets: 'Sets',
                    reps: 'Reps',
                    repsHint: 'Range or fixed number',
                    notes: 'Notes (optional)',
                    notesPlaceholder: 'E.g.: focus on technique',
                    cancel: 'CANCEL',
                    save: 'SAVE',
                    ladderInfo: 'Modify the number of ladders and rungs. Increase rungs for more volume, reduce for more intensity.',
                    clusterInfo: 'Modify the number of clusters and breakdown. Keep intra-cluster rest brief to preserve power.',
                    straightInfo: 'Modify sets and reps. For hypertrophy use 8-12 reps, for strength 3-6 reps.'
                },
                // Propagate Modal
                propagate: {
                    title: '🔄 PROPAGATE CHANGES',
                    question: 'Do you want to apply this change to other weeks as well?',
                    thisWeek: 'This week only',
                    thisWeekDesc: 'The change will be applied only to Week',
                    allWeeks: 'All weeks',
                    allWeeksDesc: 'Apply to all weeks of the program',
                    range: 'Custom range',
                    rangeDesc: 'Choose specific weeks',
                    sameDay: 'Same day, all weeks',
                    sameDayDesc: 'Apply only to Day',
                    fromWeek: 'From week:',
                    toWeek: 'To week:',
                    preview: 'Preview: changes will be applied to:',
                    apply: 'APPLY'
                },
                // Warnings
                warnings: {
                    title: '⚠️ WARNING',
                    noPull: 'No PULL exercise (row) selected. This may create muscle imbalances.',
                    noHinge: 'No HINGE exercise (deadlift/swing) selected.',
                    noSquat: 'No SQUAT exercise selected.',
                    powerNoBallistic: 'For POWER goal it is recommended to include ballistic exercises (Swing, Snatch, Clean, Jerk, Push Press) to leverage the Cluster method.',
                    beginnerAdvanced: 'For beginners it is recommended to start with basic exercises before moving to advanced ones.',
                    proceed: 'PROCEED ANYWAY',
                    goBack: 'GO BACK TO SELECTION'
                },
                // Toasts
                toasts: {
                    presetApplied: 'Preset applied! You can modify it before generating.',
                    editSaved: 'Edit saved!',
                    editApplied: 'Edit applied to {count} exercises!',
                    minExercises: 'Select at least 4 exercises to generate the program.'
                },
                // Timer
                timer: {
                    rest: 'REST PERIOD',
                    start: 'START',
                    reset: 'RESET'
                },
                // Phases
                phases: {
                    accumulation: 'Accumulation',
                    intensification: 'Intensification',
                    realization: 'Realization',
                    deload: 'Deload'
                },
                // Load guidance
                loadGuidance: {
                    increase: '↑ INCREASE KB',
                    deload: 'Same KB as W1, RPE 6-7'
                },
                // Badges
                badges: {
                    modified: 'MODIFIED',
                    propagated: 'PROPAGATED'
                },
                // Placeholder
                placeholder: {
                    title: 'AWAITING ORDERS',
                    desc: 'Configure parameters, select exercises, and generate your protocol'
                },
                // Footer
                footer: 'IRON PROTOCOL™ | KETTLEBELL TRAINING COMMAND | EVIDENCE-BASED PROGRAMMING'
            }
        };

        // Get translation
        function t(key) {
            const keys = key.split('.');
            let value = translations[state.currentLang];
            for (const k of keys) {
                if (value && value[k] !== undefined) {
                    value = value[k];
                } else {
                    // Fallback to Italian
                    value = translations.it;
                    for (const k2 of keys) {
                        if (value && value[k2] !== undefined) {
                            value = value[k2];
                        } else {
                            return key; // Return key if not found
                        }
                    }
                    break;
                }
            }
            return value;
        }

        // Update all UI text
        function updateLanguage() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = t(key);
                if (typeof translation === 'string') {
                    el.textContent = translation;
                }
            });

            // Update all elements with data-i18n-placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });

            // Update frequency select options
            const freqSelect = document.getElementById('frequency');
            if (freqSelect) {
                const freqLabel = state.currentLang === 'it' ? 'Sessioni / Settimana' : 'Sessions / Week';
                freqSelect.querySelectorAll('option').forEach(opt => {
                    opt.textContent = `${opt.value} ${freqLabel}`;
                });
            }

            // Update program length select options
            const progSelect = document.getElementById('programLength');
            if (progSelect) {
                const weeksLabel = state.currentLang === 'it' ? 'Settimane' : 'Weeks';
                progSelect.querySelectorAll('option').forEach(opt => {
                    opt.textContent = `${opt.value} ${weeksLabel}`;
                });
            }

            // Update language toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === state.currentLang);
            });

            // Update HTML lang attribute
            document.documentElement.lang = state.currentLang;

            // Store preference
            localStorage.setItem('ironProtocolLang', state.currentLang);
        }

        // Initialize language toggle
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                state.currentLang = btn.dataset.lang;
                updateLanguage();
                // Re-render program if exists
                if (state.currentProgram) {
                    renderProgram(state.currentProgram, true);
                }
            });
        });

        document.getElementById('programsGenerated').textContent = state.programsGenerated;

        // Preset program definitions
        const presetPrograms = {
            strength: {
                name: 'Iron Strength',
                goal: 'strength',
                level: 'intermediate',
                equipment: 'single',
                frequency: 3,
                duration: 45,
                programLength: 12,
                exercises: [
                    'Deadlift',
                    'Sumo Deadlift',
                    'Military Press',
                    'Goblet Squat',
                    'Bent Over Row',
                    'Single Arm Row',
                    'Rack Lunge',
                    'Rack Carry'
                ]
            },
            power: {
                name: 'Explosive Power',
                goal: 'power',
                level: 'intermediate',
                equipment: 'single',
                frequency: 3,
                duration: 40,  // Shorter sessions, higher quality
                programLength: 12,
                exercises: [
                    'Snatch',           // Primary ballistic - upper/full body
                    'Clean',            // Primary ballistic - hip hinge
                    'Two-Hand Swing',   // Foundation ballistic
                    'Jump Squat',       // Ballistic lower body
                    'Push Press',       // Ballistic push
                    'Bent Over Row',    // Balance - pull
                    'Rack Carry'        // Core stability
                ]
            },
            fitness: {
                name: 'Total Fitness',
                goal: 'general',
                level: 'intermediate',
                equipment: 'single',
                frequency: 3,
                duration: 45,  // Realistic with volume caps
                programLength: 12,
                exercises: [
                    'Two-Hand Swing',   // Primary hinge/conditioning
                    'Goblet Squat',     // Primary squat
                    'Military Press',   // Primary push
                    'Bent Over Row',    // Primary pull
                    'Reverse Lunge',    // Accessory lower
                    'Clean'             // Conditioning/skill
                ]
            },
            hypertrophy: {
                name: 'Muscle Builder',
                goal: 'hypertrophy',
                level: 'intermediate',
                equipment: 'single',
                frequency: 4,
                duration: 50,
                programLength: 12,
                exercises: [
                    'Deadlift',
                    'Good Morning',
                    'Goblet Squat',
                    'Somersault Squat',
                    'Military Press',
                    'Floor Press',
                    'Bent Over Row',
                    'Rack Lunge',
                    'Suitcase Carry'
                ]
            }
        };

        // Exercise priority by motor unit recruitment (lower = harder = first)
        const exercisePriority = {
            // Tier 1: Heavy bilateral compound / ballistic (highest MU recruitment)
            'Double Swing': 1,
            'Double Clean': 1,
            'Double Front Squat': 1,
            'Deadlift': 2,
            'Sumo Deadlift': 2,
            
            // Tier 2: Full-body ballistic
            'Snatch': 3,
            'Dead Snatch': 3,
            'Jerk': 3,
            'Double Press': 4,
            
            // Tier 3: Heavy unilateral / bilateral compound
            'Goblet Squat': 5,
            'Clean': 5,
            'Hang Clean': 5,
            'Two-Hand Swing': 6,
            'High Pull': 6,
            
            // Tier 4: Ballistic single-arm
            'One-Hand Swing': 7,
            'Hand-to-Hand Swing': 7,
            
            // Tier 5: Pressing
            'Military Press': 8,
            'Push Press': 8,
            'See-Saw Press': 9,
            'Floor Press': 10,
            
            // Tier 6: Rows/Pulls
            'Gorilla Row': 11,
            'Renegade Row': 11,
            'Bent Over Row': 12,
            'Single Arm Row': 13,
            
            // Tier 7: Unilateral lower body & secondary squats
            'Jump Squat': 5,  // High priority for Power (ballistic)
            'Somersault Squat': 14,
            'Rack Lunge': 15,
            'Reverse Lunge': 15,
            'Walking Lunge': 16,
            'Lateral Lunge': 16,
            
            // Tier 8: Hinges (lighter)
            'Single Leg Deadlift': 17,
            'Good Morning': 18,
            
            // Tier 9: Carries (lowest for main work)
            'Farmers Carry': 19,
            'Rack Carry': 20,
            'Suitcase Carry': 20,
            'Overhead Carry': 21
        };

        // Cluster-eligible exercises (ballistic/explosive only)
        const clusterEligible = {
            'Two-Hand Swing': true,
            'One-Hand Swing': true,
            'Hand-to-Hand Swing': true,
            'Double Swing': true,
            'Clean': true,
            'Double Clean': true,
            'Hang Clean': true,
            'Snatch': true,
            'Dead Snatch': true,
            'Jerk': true,
            'High Pull': true,
            'Push Press': true,
            'Jump Squat': true  // Ballistic squat
        };

        // Exercise complexity (for beginner warnings)
        const advancedExercises = {
            'Snatch': true,
            'Dead Snatch': true,
            'Jerk': true,
            'Renegade Row': true,
            'Jump Squat': true,  // Requires good squat mechanics
            'Single Leg Deadlift': true,
            'Overhead Carry': true,
            'See-Saw Press': true,
            'Double Clean': true,
            'Double Swing': true,
            'Double Front Squat': true,
            'Double Press': true
        };

        // Beginner-friendly alternatives
        const beginnerAlternatives = {
            'Snatch': 'Two-Hand Swing',
            'Dead Snatch': 'Two-Hand Swing',
            'Jerk': 'Push Press',
            'Hang Clean': 'Clean',
            'Renegade Row': 'Bent Over Row',
            'Jump Squat': 'Goblet Squat',
            'Single Leg Deadlift': 'Deadlift',
            'See-Saw Press': 'Military Press'
        };

        function isClusterEligible(exerciseName) {
            return clusterEligible[exerciseName] || false;
        }

        function isAdvancedExercise(exerciseName) {
            return advancedExercises[exerciseName] || false;
        }

        function getExercisePriority(exerciseName) {
            return exercisePriority[exerciseName] || 50;
        }

        // Session structure by pattern focus (for balanced weekly distribution)
        const sessionStructures = {
            hinge: {
                name: 'HINGE DOMINANT',
                primary: ['hinge'],          // Gets ladders
                secondary: ['squat', 'push'], // Gets straight sets
                accessory: ['pull', 'carry']
            },
            squat: {
                name: 'SQUAT DOMINANT',
                primary: ['squat', 'lunge'],  // Gets ladders
                secondary: ['push', 'hinge'], // Gets straight sets
                accessory: ['pull', 'carry']
            },
            balanced: {
                name: 'FULL BODY',
                primary: ['hinge', 'push'],   // Gets ladders
                secondary: ['squat', 'pull'], // Gets straight sets
                accessory: ['lunge', 'carry']
            },
            push: {
                name: 'PUSH DOMINANT',
                primary: ['push'],            // Gets ladders
                secondary: ['squat', 'hinge'],
                accessory: ['pull', 'carry', 'lunge']
            },
            pull: {
                name: 'PULL DOMINANT',
                primary: ['pull', 'hinge'],
                secondary: ['squat', 'push'],
                accessory: ['lunge', 'carry']
            }
        };

        // Intensity profiles for H/L/M periodization
        const intensityProfiles = {
            2: ['heavy', 'medium'],
            3: ['heavy', 'light', 'medium'],
            4: ['heavy', 'light', 'medium', 'light'],
            5: ['heavy', 'light', 'medium', 'light', 'medium']
        };

        // Pattern focus by day for balanced programming
        const patternFocusByDay = {
            2: ['hinge', 'squat'],
            3: ['hinge', 'squat', 'balanced'],
            4: ['hinge', 'squat', 'balanced', 'push'],
            5: ['hinge', 'squat', 'balanced', 'push', 'pull']
        };

        function getIntensityProfile(dayNum, frequency) {
            const pattern = intensityProfiles[frequency] || intensityProfiles[3];
            return pattern[(dayNum - 1) % pattern.length];
        }

        function getPatternFocus(dayNum, frequency) {
            const pattern = patternFocusByDay[frequency] || patternFocusByDay[3];
            return pattern[(dayNum - 1) % pattern.length];
        }

        // REAL H/L/M differences for strength training
        const strengthIntensityParams = {
            heavy: { 
                maxLadderExercises: 2,  // 2 exercises get ladders
                ladderMultiplier: 1.0,   // Full ladders
                straightSetsMultiplier: 0.75, // Secondary work reduced
                rpe: '8-9',
                description: 'Volume pieno su esercizi primari'
            },
            light: { 
                maxLadderExercises: 1,   // Only 1 exercise gets ladders
                ladderMultiplier: 0.5,   // Half the ladders
                straightSetsMultiplier: 0.5,
                rpe: '6-7',
                description: 'Tecnica e recupero, RPE basso'
            },
            medium: { 
                maxLadderExercises: 2,
                ladderMultiplier: 0.75,
                straightSetsMultiplier: 0.75,
                rpe: '7-8',
                description: 'Volume moderato'
            }
        };

        // Training parameters per goal - with methods and progressions
        const trainingParams = {
            general: {
                name: 'GENERAL FITNESS',
                method: 'straight',
                repRange: { min: 8, max: 12 },
                sets: { min: 2, max: 3 },  // Reduced from 3-4
                restSeconds: { min: 45, max: 75 },  // Slightly shorter for conditioning
                rpe: { min: 6, max: 8 },
                tempo: null,
                includeFinisher: true,
                finisherType: 'circuit',
                // Volume caps for realistic sessions
                maxRepsPerExercise: 45,  // Hard cap: never exceed this
                maxMainExercises: 4,     // Limit main exercises
                maxTotalReps: 150,       // Per session cap (excluding finisher)
                progression: {
                    type: 'undulating',
                    description: 'Undulating Volume: Moderate → Build → Peak → Deload',
                    weeklyChanges: [
                        // Block 1: Establish baseline
                        { week: 1, setsModifier: 0, repsModifier: 0, finisherIntensity: 'light', note: 'W1: Baseline - stabilisci i pesi, finisher leggero' },
                        { week: 2, setsModifier: 0, repsModifier: 1, finisherIntensity: 'moderate', note: 'W2: +1 rep per set' },
                        { week: 3, setsModifier: 0, repsModifier: 2, finisherIntensity: 'moderate', note: 'W3: +2 reps (volume peak reps)' },
                        { week: 4, setsModifier: 1, repsModifier: -1, finisherIntensity: 'light', note: 'W4: +1 set, reset reps, finisher ridotto' },
                        { week: 5, setsModifier: 1, repsModifier: 0, finisherIntensity: 'none', note: 'W5: Peak sets - NO finisher (tempo target)' },
                        { week: 6, setsModifier: -1, repsModifier: -2, finisherIntensity: 'light', note: 'DELOAD - volume -40%', isDeload: true },
                        // Block 2: Repeat with slight progression
                        { week: 7, setsModifier: 0, repsModifier: 0, finisherIntensity: 'moderate', note: 'W7: Reset - nuovo blocco' },
                        { week: 8, setsModifier: 0, repsModifier: 1, finisherIntensity: 'moderate', note: 'W8: +1 rep per set' },
                        { week: 9, setsModifier: 0, repsModifier: 2, finisherIntensity: 'moderate', note: 'W9: +2 reps' },
                        { week: 10, setsModifier: 1, repsModifier: -1, finisherIntensity: 'light', note: 'W10: +1 set, finisher ridotto' },
                        { week: 11, setsModifier: 1, repsModifier: 0, finisherIntensity: 'none', note: 'W11: Peak - NO finisher' },
                        { week: 12, setsModifier: -1, repsModifier: -2, finisherIntensity: 'light', note: 'W12: DELOAD finale', isDeload: true }
                    ]
                },
                notes: [
                    'TARGET 45 MIN: 5\' warm-up + 30-32\' lavoro + 6-8\' finisher',
                    'MAX 4 esercizi principali per sessione (priorità: hinge → squat → push → pull)',
                    'VOLUME CAP: max ~45 reps per esercizio, ~150 reps totali per sessione',
                    'Finisher solo in settimane a volume moderato. Nelle settimane peak (W5, W11): SKIP finisher.',
                    'Se sfori i 45 min: riduci 1 set dall\'ultimo esercizio O accorcia il finisher',
                    'RPE 6-8: sforzo moderato, 2-4 reps in riserva. Non andare a cedimento.'
                ],
                autoregulation: [
                    'Se la sessione supera 50 min → la prossima volta riduci 1 set per esercizio',
                    'Se non recuperi tra le sessioni → salta il finisher per 1-2 settimane',
                    'Se completi tutto sotto RPE 6 → aumenta il carico del 5-10%',
                    'Heavy day: finisher opzionale | Light/Medium: finisher incluso'
                ]
            },
            strength: {
                name: 'MAXIMUM STRENGTH',
                method: 'ladder',
                // Ladders vary by intensity profile
                ladders: {
                    beginner: { rungs: [1, 2, 3], totalReps: 6 },
                    intermediate: { rungs: [1, 2, 3, 4], totalReps: 10 },
                    advanced: { rungs: [1, 2, 3, 4, 5], totalReps: 15 }
                },
                // Reduced ladder variants for Light days
                laddersLight: {
                    beginner: { rungs: [1, 2], totalReps: 3 },
                    intermediate: { rungs: [1, 2, 3], totalReps: 6 },
                    advanced: { rungs: [1, 2, 3], totalReps: 6 }
                },
                // Intensification ladders (shorter, heavier)
                laddersIntense: {
                    beginner: { rungs: [1, 2], totalReps: 3 },
                    intermediate: { rungs: [1, 2, 3], totalReps: 6 },
                    advanced: { rungs: [1, 2, 3], totalReps: 6 }
                },
                repRange: { min: 3, max: 6 }, // For straight sets on non-ladder exercises
                sets: { min: 3, max: 4 },
                restSeconds: { min: 120, max: 180 },
                rpe: { min: 7, max: 9 },
                tempo: null,
                includeFinisher: false,
                finisherType: null,
                // Max exercises that get ladders per session
                maxLadderExercises: 2,
                progression: {
                    type: 'wave_intensity',
                    description: 'Wave Loading: Volume → Intensification → Deload',
                    weeklyChanges: [
                        { week: 1, phase: 'accumulation', numLadders: 3, useIntenseLadders: false, note: 'W1: Accumulo - 3 ladders, stabilisci il carico' },
                        { week: 2, phase: 'accumulation', numLadders: 4, useIntenseLadders: false, note: 'W2: Accumulo - 4 ladders, volume peak' },
                        { week: 3, phase: 'accumulation', numLadders: 4, useIntenseLadders: false, note: 'W3: Accumulo - mantieni volume, affina tecnica' },
                        { week: 4, phase: 'intensification', numLadders: 3, useIntenseLadders: true, note: 'W4: Intensificazione - SALI DI KB, rungs ridotte' },
                        { week: 5, phase: 'realization', numLadders: 2, useIntenseLadders: true, note: 'W5: Realizzazione - volume basso, carico alto, test' },
                        { week: 6, phase: 'deload', numLadders: 2, useIntenseLadders: false, note: 'DELOAD - volume -50%, RPE 6-7, recupero', isDeload: true }
                    ]
                },
                notes: [
                    'LADDERS solo su 1-2 esercizi principali per seduta. Gli altri in straight sets.',
                    'W1-3 ACCUMULO: Stabilisci il carico. Se completi tutte le rungs a RPE ≤7, ANNOTALO.',
                    'W4-5 INTENSIFICAZIONE: SALI DI KB e riduci le rungs. Es: da 16kg×(1-2-3-4) a 20kg×(1-2-3).',
                    'Se non riesci a completare la ladder: riduci 1 rung O 1 ladder, NON il carico.',
                    'HEAVY: 2 esercizi a ladders complete | LIGHT: 1 esercizio, rungs ridotte, RPE 6-7 | MEDIUM: 2 esercizi, volume moderato',
                    'Rest: 30-60s tra rungs, 2-3 min tra ladders. Non avere fretta.',
                    'DELOAD W6: stesso carico di W1, volume -50%, nessun grind.'
                ],
                autoregulation: [
                    'Se completi tutte le ladders a RPE ≤7 per 2 sessioni consecutive → prossima settimana sali di KB',
                    'Se non completi le rungs previste → riduci di 1 rung ma MANTIENI il carico',
                    'Se fallisci 2 sessioni consecutive → torna al KB precedente con rungs complete',
                    'Con 1 solo KB: usa rungs più lunghe (1-2-3-4-5-6) invece di salire di carico',
                    'Con 2 KB: alterna (es. 16kg W1-3, 20kg W4-5, 16kg W6 deload)'
                ]
            },
            power: {
                name: 'EXPLOSIVE POWER',
                method: 'cluster',
                clusters: {
                    // Smaller clusters = better power output
                    beginner: { breakdown: [2, 2], total: 4, intraRest: 20 },
                    intermediate: { breakdown: [2, 2, 2], total: 6, intraRest: 15 },
                    advanced: { breakdown: [3, 2, 2], total: 7, intraRest: 15 }
                },
                repRange: { min: 3, max: 6 },  // Lower reps for power
                sets: { min: 3, max: 4 },      // Fewer sets, higher quality
                restSeconds: { min: 150, max: 240 },  // Longer rest for power
                rpe: { min: 7, max: 8 },
                tempo: 'MAX VELOCITY',
                includeFinisher: false,  // No finisher - keep CNS fresh
                finisherType: null,
                maxBallisticPerSession: 2,  // Limit ballistic exercises
                progression: {
                    type: 'power_periodization',
                    description: 'Power Periodization: Technical → Velocity',
                    // Phase 1: Technical Volume (W1-5) - Build movement quality
                    // Phase 2: Velocity/Intensity (W7-11) - Max speed, less volume
                    weeklyChanges: [
                        // PHASE 1: TECHNICAL VOLUME (accumulate quality reps)
                        { week: 1, numClusters: 3, phase: 'technical', note: 'W1: Tecnica - 3 clusters, stabilisci velocità base', phaseNote: 'FASE 1: VOLUME TECNICO' },
                        { week: 2, numClusters: 3, phase: 'technical', note: 'W2: Tecnica - mantieni qualità, aumenta controllo' },
                        { week: 3, numClusters: 4, phase: 'technical', note: 'W3: Volume - 4 clusters, stesso tempo' },
                        { week: 4, numClusters: 4, phase: 'technical', note: 'W4: Volume - consolida pattern' },
                        { week: 5, numClusters: 4, addRep: true, phase: 'technical', note: 'W5: Peak tecnico - 4 clusters + 1 rep' },
                        // DELOAD 1
                        { week: 6, numClusters: 2, reduceExercises: true, phase: 'deload', note: 'W6: DELOAD - 2 clusters, -50% esercizi, recupero', isDeload: true },
                        // PHASE 2: VELOCITY/INTENSITY (max speed, less volume)
                        { week: 7, numClusters: 3, phase: 'velocity', note: 'W7: Velocità - 3 clusters, MAX SPEED ogni rep', phaseNote: 'FASE 2: VELOCITÀ PURA' },
                        { week: 8, numClusters: 3, phase: 'velocity', note: 'W8: Velocità - concentra energia su meno rep' },
                        { week: 9, numClusters: 3, shorterClusters: true, phase: 'velocity', note: 'W9: Esplosività - cluster più corti (2+2)' },
                        { week: 10, numClusters: 3, shorterClusters: true, phase: 'velocity', note: 'W10: Peak velocità - max intent ogni rep' },
                        { week: 11, numClusters: 3, testWeek: true, phase: 'velocity', note: 'W11: Test - valuta guadagni di potenza' },
                        // DELOAD 2
                        { week: 12, numClusters: 2, reduceExercises: true, phase: 'deload', note: 'W12: DELOAD - recupero completo', isDeload: true }
                    ]
                },
                notes: [
                    'POWER = Forza × Velocità. Volume basso, qualità altissima.',
                    'CLUSTER solo su balistici: Swing, Snatch, Clean, Jerk, Push Press, Jump Squat',
                    'MAX 2 esercizi balistici per seduta - altri in straight sets leggeri',
                    'Se la velocità cala → FERMA il set. Non esistono rep lente nel power training.',
                    'Recupero COMPLETO tra cluster (2.5-4 min). Il recupero È l\'allenamento.',
                    'Fase 1: Costruisci il pattern. Fase 2: Esprimi velocità.'
                ],
                autoregulation: [
                    'Se la velocità cala durante un cluster → termina il cluster, aggiungi recupero',
                    'Se non riesci a mantenere velocità massima → riduci i cluster, non le rep',
                    'Nei giorni "off" evita lavoro ad alta intensità - il CNS ha bisogno di recuperare',
                    'Dopo W11: se ti senti esplosivo, ripeti Fase 2. Se affaticato, estendi deload.'
                ]
            },
            hypertrophy: {
                name: 'MUSCLE HYPERTROPHY',
                method: 'straight',
                repRange: { min: 8, max: 15 },
                sets: { min: 3, max: 5 },
                restSeconds: { min: 60, max: 120 },
                rpe: { min: 7, max: 9 },
                tempo: '3-1-2-0',
                includeFinisher: true,
                finisherType: 'volume',
                progression: {
                    type: 'double_progression',
                    description: 'Double Progression (Reps → Sets)',
                    weeklyChanges: [
                        { week: 1, setsModifier: 0, targetReps: 'low', note: 'Start at low end of rep range' },
                        { week: 2, setsModifier: 0, targetReps: 'mid-low', note: 'Add 1-2 reps per set' },
                        { week: 3, setsModifier: 0, targetReps: 'mid', note: 'Mid rep range' },
                        { week: 4, setsModifier: 0, targetReps: 'mid-high', note: 'Add 1-2 reps per set' },
                        { week: 5, setsModifier: 1, targetReps: 'low', note: 'Add 1 set, reset to low reps' },
                        { week: 6, setsModifier: -1, targetReps: 'low', note: 'DELOAD - reduce sets, light effort', isDeload: true }
                    ]
                },
                notes: [
                    'DOUBLE PROGRESSION: Increase reps weekly → add set when you hit top of range → reset reps',
                    'Tempo 3-1-2-0: 3s eccentric, 1s pause, 2s concentric - maintain TUT',
                    'Train close to failure (1-3 RIR) on work sets except deload',
                    'Deload week: same tempo, fewer sets, RPE 5-6'
                ]
            },
            fatloss: {
                name: 'FAT LOSS / METABOLIC',
                method: 'straight',
                repRange: { min: 10, max: 20 },
                sets: { min: 3, max: 4 },
                restSeconds: { min: 30, max: 60 },
                rpe: { min: 7, max: 8 },
                tempo: null,
                includeFinisher: true,
                finisherType: 'hiit',
                progression: {
                    type: 'density',
                    description: 'Density Progression (Rest Reduction)',
                    weeklyChanges: [
                        { week: 1, restModifier: 0, finisherRounds: 6, note: 'Baseline rest periods' },
                        { week: 2, restModifier: -5, finisherRounds: 7, note: 'Reduce rest 5s, +1 finisher round' },
                        { week: 3, restModifier: -10, finisherRounds: 8, note: 'Reduce rest 10s, +2 finisher rounds' },
                        { week: 4, restModifier: -10, finisherRounds: 9, note: 'Maintain rest, +3 finisher rounds' },
                        { week: 5, restModifier: -15, finisherRounds: 10, note: 'Reduce rest 15s, +4 finisher rounds' },
                        { week: 6, restModifier: 0, finisherRounds: 5, note: 'DELOAD - restore rest, easy finisher', isDeload: true }
                    ]
                },
                notes: [
                    'DENSITY PROGRESSION: Reduce rest between sets weekly + add finisher rounds',
                    'Rest reduction increases metabolic demand without adding volume',
                    'Maintain rep quality - if form breaks, rest longer',
                    'Deload week: normal rest periods, reduced finisher volume'
                ]
            },
            endurance: {
                name: 'MUSCULAR ENDURANCE',
                method: 'straight',
                repRange: { min: 15, max: 30 },
                sets: { min: 2, max: 4 },
                restSeconds: { min: 30, max: 60 },
                rpe: { min: 6, max: 8 },
                tempo: null,
                includeFinisher: true,
                finisherType: 'amrap',
                progression: {
                    type: 'volume_linear',
                    description: 'Linear Volume Progression',
                    weeklyChanges: [
                        { week: 1, setsModifier: 0, repsModifier: 0, note: 'Baseline - mid rep range' },
                        { week: 2, setsModifier: 0, repsModifier: 2, note: 'Add 2 reps per set' },
                        { week: 3, setsModifier: 0, repsModifier: 4, note: 'Add 4 reps per set' },
                        { week: 4, setsModifier: 1, repsModifier: 0, note: 'Add 1 set, reset reps' },
                        { week: 5, setsModifier: 1, repsModifier: 3, note: 'Keep extra set, add 3 reps' },
                        { week: 6, setsModifier: -1, repsModifier: -3, note: 'DELOAD - reduce volume 40%', isDeload: true }
                    ]
                },
                notes: [
                    'LINEAR PROGRESSION: Add reps weekly → add sets → deload week 6',
                    'High rep ranges build muscular endurance and aerobic capacity',
                    'Focus on sustainable pace and rhythmic breathing',
                    'Deload week: reduce total volume, maintain movement quality'
                ]
            }
        };

        const finishers = {
            circuit: [
                { name: 'KB Circuit', desc: '3-4 exercises, 30s each, 3-4 rounds', duration: '8-12 min', intensity: 'moderate' },
                { name: 'Strength Circuit', desc: '4 exercises, 8-12 reps each, 3 rounds', duration: '10-12 min', intensity: 'moderate' }
            ],
            circuitLight: [
                { name: 'Quick Circuit', desc: '3 exercises, 30s each, 2 rounds', duration: '5-6 min', intensity: 'light' },
                { name: 'Mini Finisher', desc: '2 exercises, 8-10 reps, 2 rounds', duration: '4-5 min', intensity: 'light' }
            ],
            volume: [
                { name: 'Pump Finisher', desc: 'Single exercise, 3×15-20 reps, 45s rest', duration: '6-8 min', intensity: 'moderate' },
                { name: 'Giant Set', desc: '3 exercises same muscle, 10-12 reps, minimal rest', duration: '8-10 min', intensity: 'moderate' }
            ],
            hiit: [
                { name: 'Swing Intervals', desc: '20s max effort / 40s rest × 10 rounds', duration: '10 min', intensity: 'moderate' },
                { name: 'Metabolic Blast', desc: '15s work / 15s rest × 20 rounds', duration: '10 min', intensity: 'moderate' }
            ],
            amrap: [
                { name: 'AMRAP 10', desc: 'Max quality rounds in 10 minutes', duration: '10 min', intensity: 'moderate' },
                { name: 'AMRAP 15', desc: 'Max quality rounds in 15 minutes', duration: '15 min', intensity: 'high' }
            ]
        };

        // DOM Elements
        const equipmentInputs = document.querySelectorAll('input[name="equipment"]');
        const exerciseCheckboxes = document.querySelectorAll('input[name="exercise"]');
        const durationSlider = document.getElementById('duration');
        const durationValue = document.getElementById('durationValue');
        const generateBtn = document.getElementById('generateBtn');
        const programOutput = document.getElementById('programOutput');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const selectedCountEl = document.getElementById('selectedCount');
        const selectionWarning = document.getElementById('selectionWarning');

        // Initialize
        updateExerciseAvailability();
        updateSelectedCount();
        
        // Initialize collapsible categories on mobile
        function initMobileCategories() {
            if (window.innerWidth <= 768) {
                const categories = document.querySelectorAll('.exercise-category');
                categories.forEach((cat, index) => {
                    // Collapse all except first category on mobile
                    if (index > 0) {
                        cat.classList.add('collapsed');
                    }
                    
                    // Add click handler to header for collapse toggle
                    const header = cat.querySelector('.category-header h3');
                    if (header) {
                        header.style.cursor = 'pointer';
                        header.addEventListener('click', (e) => {
                            e.stopPropagation();
                            cat.classList.toggle('collapsed');
                        });
                    }
                });
            }
        }
        
        // Run on load and resize
        initMobileCategories();
        window.addEventListener('resize', () => {
            const categories = document.querySelectorAll('.exercise-category');
            if (window.innerWidth > 768) {
                // Remove collapsed class on desktop
                categories.forEach(cat => cat.classList.remove('collapsed'));
            }
        });

        // Event Listeners
        durationSlider.addEventListener('input', (e) => {
            durationValue.textContent = e.target.value;
        });

        equipmentInputs.forEach(input => {
            input.addEventListener('change', updateExerciseAvailability);
        });

        exerciseCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        generateBtn.addEventListener('click', generateProgram);
        
        // Mobile generate button
        const mobileGenerateBtn = document.getElementById('mobileGenerateBtn');
        if (mobileGenerateBtn) {
            mobileGenerateBtn.addEventListener('click', generateProgram);
        }

        // Preset program selection handlers
        const presetCards = document.querySelectorAll('.preset-card');
        presetCards.forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.classList.contains('preset-btn')) {
                    applyPreset(card.dataset.preset);
                }
            });
            
            // Also handle click on the whole card
            card.querySelector('.preset-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                applyPreset(card.dataset.preset);
            });
        });

        function applyPreset(presetKey) {
            const preset = presetPrograms[presetKey];
            if (!preset) return;

            // Update visual selection
            presetCards.forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-preset="${presetKey}"]`).classList.add('selected');
            state.selectedPreset = presetKey;

            // Set equipment
            document.querySelector(`input[name="equipment"][value="${preset.equipment}"]`).checked = true;
            updateExerciseAvailability();

            // Set goal
            document.querySelector(`input[name="goal"][value="${preset.goal}"]`).checked = true;

            // Set level
            document.querySelector(`input[name="level"][value="${preset.level}"]`).checked = true;

            // Set frequency (it's a select, not a slider)
            document.getElementById('frequency').value = preset.frequency;

            // Set duration (slider with display span)
            document.getElementById('duration').value = preset.duration;
            const durationValueEl = document.getElementById('durationValue');
            if (durationValueEl) {
                durationValueEl.textContent = preset.duration;
            }

            // Set program length (it's a select, not a slider)
            document.getElementById('programLength').value = preset.programLength;

            // Clear all exercise selections first
            exerciseCheckboxes.forEach(cb => {
                cb.checked = false;
            });

            // Select preset exercises
            preset.exercises.forEach(exerciseName => {
                const checkbox = document.querySelector(`input[name="exercise"][value="${exerciseName}"]`);
                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = true;
                }
            });

            // Update count and scroll to exercises panel
            updateSelectedCount();

            // Visual feedback - flash the exercise panel
            const exercisePanel = document.querySelector('.panel:nth-child(3)');
            if (exercisePanel) {
                exercisePanel.style.transition = 'box-shadow 0.3s ease';
                exercisePanel.style.boxShadow = '0 0 20px rgba(196,160,53,0.5)';
                setTimeout(() => {
                    exercisePanel.style.boxShadow = '';
                }, 1000);
            }

            // Show confirmation message
            showPresetConfirmation(preset.name);
        }

        function showPresetConfirmation(presetName) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'preset-toast';
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                <span>Preset "${presetName}" applicato! Puoi modificarlo prima di generare.</span>
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function showMinimumSelectionToast() {
            const toast = document.createElement('div');
            toast.className = 'preset-toast';
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M11 15h2v2h-2zm0-8h2v6h-2zm1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                <span>${t('toasts.minExercises')}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function isMobileDevice() {
            return /android|iphone|ipad|ipod/i.test(navigator.userAgent);
        }

        async function handlePrint() {
            const programOutput = document.getElementById('programOutput');

            if (isMobileDevice()) {
                await downloadProgramAsPdf(programOutput);
                return;
            }

            window.print();
        }

        async function downloadProgramAsPdf(container) {
            if (!container || !container.innerHTML.trim()) {
                return;
            }

            const { jsPDF } = window.jspdf || {};

            if (!window.html2canvas || !jsPDF) {
                window.print();
                return;
            }

            let pdfRoot = null;
            document.body.classList.add('pdf-export');

            try {
                pdfRoot = container.cloneNode(true);
                pdfRoot.id = 'programPdfCapture';
                pdfRoot.classList.add('pdf-capture');
                pdfRoot.style.position = 'absolute';
                pdfRoot.style.left = '-9999px';
                pdfRoot.style.top = '0';
                pdfRoot.style.width = `${Math.min(container.offsetWidth, 1100)}px`;

                pdfRoot.querySelectorAll('.week-content').forEach(section => section.classList.add('active'));
                pdfRoot.querySelectorAll('.week-tabs').forEach(tabs => tabs.remove());
                pdfRoot.querySelectorAll('.action-buttons').forEach(actions => actions.remove());

                document.body.appendChild(pdfRoot);

                const canvas = await window.html2canvas(pdfRoot, {
                    scale: 2,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth;
                const imgHeight = canvas.height * (imgWidth / canvas.width);

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('iron-protocol.pdf');
            } finally {
                if (pdfRoot && pdfRoot.parentNode) {
                    pdfRoot.parentNode.removeChild(pdfRoot);
                }
                document.body.classList.remove('pdf-export');
            }
        }

        function updateExerciseAvailability() {
            const isDouble = document.querySelector('input[name="equipment"]:checked').value === 'double';
            
            exerciseCheckboxes.forEach(cb => {
                const requiresDouble = cb.dataset.double === 'true';
                
                if (requiresDouble && !isDouble) {
                    cb.disabled = true;
                    cb.checked = false;
                } else {
                    cb.disabled = false;
                }
            });
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('input[name="exercise"]:checked').length;
            selectedCountEl.textContent = count;

            if (count < 4) {
                selectionWarning.style.display = 'block';
            } else {
                selectionWarning.style.display = 'none';
            }
        }

        function toggleCategory(category) {
            const categoryEl = document.querySelector(`[data-category="${category}"]`);
            const checkboxes = categoryEl.querySelectorAll('input[type="checkbox"]:not(:disabled)');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            updateSelectedCount();
        }

        // Timer functionality
        const timerOverlay = document.getElementById('timerOverlay');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerExercise = document.getElementById('timerExercise');
        const startTimerBtn = document.getElementById('startTimer');
        const resetTimerBtn = document.getElementById('resetTimer');
        const closeTimerBtn = document.getElementById('closeTimer');

        startTimerBtn.addEventListener('click', toggleTimer);
        resetTimerBtn.addEventListener('click', resetTimer);
        closeTimerBtn.addEventListener('click', closeTimer);

        function toggleTimer() {
            if (state.timerRunning) {
                clearInterval(state.timerInterval);
                state.timerRunning = false;
                startTimerBtn.textContent = 'START';
                startTimerBtn.classList.remove('stop');
                startTimerBtn.classList.add('start');
            } else {
                state.timerInterval = setInterval(() => {
                    state.timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                state.timerRunning = true;
                startTimerBtn.textContent = 'PAUSE';
                startTimerBtn.classList.remove('start');
                startTimerBtn.classList.add('stop');
            }
        }

        function resetTimer() {
            clearInterval(state.timerInterval);
            state.timerRunning = false;
            state.timerSeconds = 0;
            updateTimerDisplay();
            startTimerBtn.textContent = 'START';
            startTimerBtn.classList.remove('stop');
            startTimerBtn.classList.add('start');
        }

        function closeTimer() {
            resetTimer();
            timerOverlay.classList.remove('active');
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timerSeconds / 60);
            const seconds = state.timerSeconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function openTimer(exerciseName) {
            timerExercise.textContent = exerciseName.toUpperCase();
            resetTimer();
            timerOverlay.classList.add('active');
        }

        function getSelectedExercises() {
            const selected = [];
            document.querySelectorAll('input[name="exercise"]:checked').forEach(cb => {
                selected.push({
                    name: cb.value,
                    pattern: cb.dataset.pattern,
                    requiresDouble: cb.dataset.double === 'true'
                });
            });
            return selected;
        }

        function checkExerciseBalance(selectedExercises, goal, level) {
            const warnings = [];
            
            // Group by pattern
            const patterns = {
                hinge: false,
                squat: false,
                push: false,
                pull: false,
                lunge: false,
                carry: false
            };
            
            selectedExercises.forEach(ex => {
                if (patterns.hasOwnProperty(ex.pattern)) {
                    patterns[ex.pattern] = true;
                }
            });
            
            // Check for missing critical patterns
            if (!patterns.pull) {
                warnings.push({
                    type: 'critical',
                    message: 'Nessun esercizio di TRAZIONE (rows/pulls) selezionato. Per la salute di spalle e postura è altamente consigliato includere almeno un row.'
                });
            }
            
            if (!patterns.hinge && !patterns.squat) {
                warnings.push({
                    type: 'critical',
                    message: 'Nessun esercizio per la CATENA POSTERIORE o GAMBE (hinge/squat). Questo limiterà significativamente i risultati.'
                });
            }
            
            // Goal-specific checks
            if (['general', 'hypertrophy', 'endurance'].includes(goal)) {
                const missingPatterns = [];
                if (!patterns.hinge) missingPatterns.push('hinge');
                if (!patterns.squat && !patterns.lunge) missingPatterns.push('squat/lunge');
                if (!patterns.push) missingPatterns.push('push');
                if (!patterns.pull) missingPatterns.push('pull');
                
                if (missingPatterns.length > 0 && missingPatterns.length <= 2 && !warnings.some(w => w.type === 'critical')) {
                    warnings.push({
                        type: 'warning',
                        message: `Per l'obiettivo "${goal}" è consigliato includere anche: ${missingPatterns.join(', ')}.`
                    });
                }
            }
            
            // Power-specific: check for cluster-eligible exercises
            if (goal === 'power') {
                const hasClusterEligible = selectedExercises.some(ex => isClusterEligible(ex.name));
                if (!hasClusterEligible) {
                    warnings.push({
                        type: 'warning',
                        message: 'Per l\'obiettivo POWER è consigliato includere esercizi balistici (Swing, Snatch, Clean, Jerk, Push Press) per sfruttare il metodo Cluster.'
                    });
                }
            }
            
            // Beginner check for advanced exercises
            if (level === 'beginner') {
                const advancedSelected = selectedExercises.filter(ex => isAdvancedExercise(ex.name));
                if (advancedSelected.length > 0 && advancedSelected.length === selectedExercises.length) {
                    const names = advancedSelected.map(ex => ex.name).join(', ');
                    warnings.push({
                        type: 'warning',
                        message: `Livello BEGINNER con soli esercizi avanzati (${names}). Considera di aggiungere esercizi più semplici come Two-Hand Swing, Goblet Squat, Bent Over Row.`
                    });
                } else if (advancedSelected.length > 2) {
                    warnings.push({
                        type: 'info',
                        message: `Hai selezionato ${advancedSelected.length} esercizi avanzati. Per un principiante, assicurati di avere una buona base tecnica prima di eseguirli.`
                    });
                }
            }
            
            return warnings;
        }

        function showWarnings(warnings, onProceed) {
            if (warnings.length === 0) {
                onProceed();
                return;
            }
            
            // Create warning modal
            const modal = document.createElement('div');
            modal.className = 'warning-modal';
            modal.innerHTML = `
                <div class="warning-modal-content">
                    <div class="warning-modal-header">
                        <h3>⚠️ ATTENZIONE</h3>
                    </div>
                    <div class="warning-modal-body">
                        ${warnings.map(w => `
                            <div class="warning-item ${w.type}">
                                <span class="warning-icon">${w.type === 'critical' ? '🚨' : w.type === 'warning' ? '⚠️' : 'ℹ️'}</span>
                                <p>${w.message}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="warning-modal-footer">
                        <button class="warning-btn proceed">PROCEDI COMUNQUE</button>
                        <button class="warning-btn cancel">TORNA ALLA SELEZIONE</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.proceed').addEventListener('click', () => {
                document.body.removeChild(modal);
                onProceed();
            });
            
            modal.querySelector('.cancel').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function generateProgram() {
            const selectedExercises = getSelectedExercises();

            if (selectedExercises.length < 4) {
                showMinimumSelectionToast();
                return;
            }
            
            const goal = document.querySelector('input[name="goal"]:checked').value;
            const level = document.querySelector('input[name="level"]:checked').value;
            
            // Check for balance warnings
            const warnings = checkExerciseBalance(selectedExercises, goal, level);
            
            showWarnings(warnings, () => {
                actuallyGenerateProgram(selectedExercises);
            });
        }

        function actuallyGenerateProgram(selectedExercises) {
            placeholder.style.display = 'none';
            programOutput.classList.remove('active');
            loading.classList.add('active');

            const config = {
                goal: document.querySelector('input[name="goal"]:checked').value,
                level: document.querySelector('input[name="level"]:checked').value,
                equipment: document.querySelector('input[name="equipment"]:checked').value,
                frequency: parseInt(document.getElementById('frequency').value),
                duration: parseInt(document.getElementById('duration').value),
                programLength: parseInt(document.getElementById('programLength').value),
                exercises: selectedExercises
            };

            setTimeout(() => {
                const program = buildProgram(config);
                renderProgram(program);
                
                state.programsGenerated++;
                localStorage.setItem('programsGenerated', state.programsGenerated);
                document.getElementById('programsGenerated').textContent = state.programsGenerated;

                loading.classList.remove('active');
                programOutput.classList.add('active');
                
                // Auto-scroll to program output on mobile
                setTimeout(() => {
                    const programPanel = document.querySelector('.program-panel');
                    if (programPanel && window.innerWidth <= 768) {
                        programPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }, 1200);
        }

        function buildProgram(config) {
            const params = trainingParams[config.goal];
            
            // Generate sessions for each week with progressions
            const weeklyProgram = [];
            
            for (let week = 1; week <= config.programLength; week++) {
                // Get week-specific progression
                const weekProgression = getWeekProgression(params, week, config.programLength);
                
                const sessions = [];
                for (let day = 1; day <= config.frequency; day++) {
                    sessions.push(buildSession(day, config, params, weekProgression, week));
                }
                
                weeklyProgram.push({
                    week: week,
                    progression: weekProgression,
                    sessions: sessions
                });
            }

            return {
                name: params.name,
                method: params.method,
                level: config.level.toUpperCase(),
                equipment: config.equipment.toUpperCase(),
                frequency: config.frequency,
                duration: config.duration,
                weeks: config.programLength,
                weeklyProgram: weeklyProgram,
                notes: params.notes,
                autoregulation: params.autoregulation || null,
                rpe: params.rpe,
                progressionType: params.progression.type,
                progressionDescription: params.progression.description
            };
        }
        
        function getWeekProgression(params, currentWeek, totalWeeks) {
            const progression = params.progression;
            
            // Handle programs longer than 6 weeks - cycle through with deloads
            let effectiveWeek = currentWeek;
            if (totalWeeks > 6) {
                // Deload every 6th week
                const cyclePosition = ((currentWeek - 1) % 6) + 1;
                effectiveWeek = cyclePosition;
            }
            
            // Find the matching week change
            const weekChange = progression.weeklyChanges.find(w => w.week === effectiveWeek) 
                || progression.weeklyChanges[progression.weeklyChanges.length - 1];
            
            return {
                ...weekChange,
                effectiveWeek: effectiveWeek,
                isDeload: weekChange.isDeload || false
            };
        }

        function buildSession(dayNum, config, params, weekProgression, weekNum) {
            const exercises = [...config.exercises];
            
            // Get intensity profile for this day (H/L/M)
            const intensityProfile = getIntensityProfile(dayNum, config.frequency);
            
            // Get pattern focus for this day (hinge/squat/balanced/push/pull)
            const patternFocus = getPatternFocus(dayNum, config.frequency);
            const sessionStructure = sessionStructures[patternFocus] || sessionStructures.balanced;
            
            // Group exercises by pattern
            const byPattern = {};
            exercises.forEach(ex => {
                if (!byPattern[ex.pattern]) byPattern[ex.pattern] = [];
                byPattern[ex.pattern].push(ex);
            });

            // Adjust based on session duration
            const targetDuration = config.duration || 45;
            let maxMainExercises, maxAccessory, allowFinisher;

            if (targetDuration <= 35) {
                maxMainExercises = 3;
                maxAccessory = 1;
                allowFinisher = false;
            } else if (targetDuration <= 50) {
                maxMainExercises = 4;
                maxAccessory = 1;
                allowFinisher = true;
            } else {
                maxMainExercises = 4;
                maxAccessory = 2;
                allowFinisher = true;
            }
            
            // Apply goal-specific limits (e.g., general fitness has maxMainExercises: 4)
            if (params.maxMainExercises) {
                maxMainExercises = Math.min(maxMainExercises, params.maxMainExercises);
            }

            const usedExercises = new Set();
            const mainExercises = [];
            
            // Get intensity parameters for strength
            const intensityParams = strengthIntensityParams[intensityProfile] || strengthIntensityParams.medium;
            
            // For LIGHT days: reduce main exercises
            if (intensityProfile === 'light') {
                maxMainExercises = Math.min(3, maxMainExercises);
            }

            // STEP 1: Select PRIMARY exercises (will get ladders in strength program)
            // Limited to 1-2 based on intensity profile
            const primaryExercises = [];
            for (const pattern of sessionStructure.primary) {
                if (primaryExercises.length >= intensityParams.maxLadderExercises) break;
                if (byPattern[pattern] && byPattern[pattern].length > 0) {
                    const available = byPattern[pattern].filter(ex => !usedExercises.has(ex.name));
                    if (available.length > 0) {
                        const selected = available[Math.floor(Math.random() * available.length)];
                        usedExercises.add(selected.name);
                        primaryExercises.push({
                            ...selected,
                            isPrimary: true
                        });
                    }
                }
            }

            // STEP 2: Select SECONDARY exercises (will get straight sets)
            const secondaryExercises = [];
            const remainingSlots = maxMainExercises - primaryExercises.length;
            
            for (const pattern of sessionStructure.secondary) {
                if (secondaryExercises.length >= remainingSlots) break;
                if (byPattern[pattern] && byPattern[pattern].length > 0) {
                    const available = byPattern[pattern].filter(ex => !usedExercises.has(ex.name));
                    if (available.length > 0) {
                        const selected = available[Math.floor(Math.random() * available.length)];
                        usedExercises.add(selected.name);
                        secondaryExercises.push({
                            ...selected,
                            isPrimary: false
                        });
                    }
                }
            }

            // Combine and sort by motor unit recruitment
            const allMainExercises = [...primaryExercises, ...secondaryExercises];
            allMainExercises.sort((a, b) => getExercisePriority(a.name) - getExercisePriority(b.name));

            // STEP 3: Format exercises with proper method assignment
            const formattedMainExercises = [];
            
            // Strength/Power: no finisher
            let allowSessionFinisher = allowFinisher;
            if (params.method === 'cluster' || params.method === 'ladder') {
                allowSessionFinisher = false;
            }
            if (intensityProfile === 'light') {
                allowSessionFinisher = false;
            }

            for (const ex of allMainExercises) {
                let useLadder = false;
                let useCluster = false;
                
                if (params.method === 'ladder' && ex.isPrimary) {
                    // STRENGTH: Only PRIMARY exercises get ladders
                    useLadder = true;
                } else if (params.method === 'cluster') {
                    // POWER: Only cluster-eligible exercises, max 2 per session
                    const ballisticCount = formattedMainExercises.filter(e => e.method === 'cluster').length;
                    const maxBallistic = params.maxBallisticPerSession || 2;
                    
                    if (isClusterEligible(ex.name) && ex.isPrimary && ballisticCount < maxBallistic) {
                        useCluster = true;
                    }
                }
                
                formattedMainExercises.push(
                    formatExercise(ex, params, config.level, weekProgression, useCluster, useLadder, intensityProfile, intensityParams)
                );
            }
            
            // POWER DELOAD: reduce number of exercises
            if (params.method === 'cluster' && weekProgression.reduceExercises) {
                // Keep only 2-3 main exercises during power deload
                while (formattedMainExercises.length > 3) {
                    formattedMainExercises.pop();
                }
            }

            // STEP 4: Build accessory exercises
            const accessoryExercises = [];
            
            for (const pattern of sessionStructure.accessory) {
                if (accessoryExercises.length >= maxAccessory) break;
                if (byPattern[pattern]) {
                    const available = byPattern[pattern].filter(ex => !usedExercises.has(ex.name));
                    if (available.length > 0) {
                        const selected = available[Math.floor(Math.random() * available.length)];
                        usedExercises.add(selected.name);
                        accessoryExercises.push(formatAccessory(selected, params, intensityProfile));
                    }
                }
            }

            // STEP 5: Finisher (not for strength/power)
            let finisher = null;
            const finisherIntensity = weekProgression.finisherIntensity || 'moderate';
            
            // Skip finisher if intensity is 'none' or not allowed
            if (finisherIntensity !== 'none' && allowSessionFinisher && params.includeFinisher && params.finisherType) {
                let finisherOptions;
                
                // Use light finisher variant if available and requested
                if (finisherIntensity === 'light' && finishers[params.finisherType + 'Light']) {
                    finisherOptions = finishers[params.finisherType + 'Light'];
                } else if (finishers[params.finisherType]) {
                    finisherOptions = finishers[params.finisherType];
                }
                
                if (finisherOptions && finisherOptions.length > 0) {
                    finisher = finisherOptions[Math.floor(Math.random() * finisherOptions.length)];
                }
            }

            return {
                day: dayNum,
                name: determineSessionName(formattedMainExercises, accessoryExercises),
                intensityProfile: intensityProfile,
                intensityDescription: intensityParams.description,
                rpeTarget: intensityParams.rpe,
                main: formattedMainExercises,
                accessory: accessoryExercises,
                finisher,
                params
            };
        }
        
        function getSessionFocus(day, frequency, byPattern) {
            // Determine what kind of session based on day and frequency
            if (frequency === 2) {
                return day === 1 ? 'fullbody' : 'fullbody';
            } else if (frequency === 3) {
                const focuses = ['push', 'pull', 'fullbody'];
                return focuses[(day - 1) % 3];
            } else if (frequency === 4) {
                const focuses = ['push', 'pull', 'lower', 'fullbody'];
                return focuses[(day - 1) % 4];
            } else {
                const focuses = ['push', 'pull', 'lower', 'fullbody', 'fullbody'];
                return focuses[(day - 1) % 5];
            }
        }
        
        function determineSessionName(mainExercises, accessoryExercises = []) {
            // Count patterns in ALL exercises (main + accessory)
            const allExercises = [...mainExercises, ...accessoryExercises];
            const patternCounts = {};
            
            allExercises.forEach(ex => {
                const pattern = ex.pattern;
                patternCounts[pattern] = (patternCounts[pattern] || 0) + 1;
            });
            
            const total = allExercises.length;
            if (total === 0) return 'FULL BODY';
            
            // Group into categories
            const lowerPatterns = ['hinge', 'squat', 'lunge'];
            const upperPatterns = ['push', 'pull'];
            
            let lowerCount = 0;
            let upperCount = 0;
            
            lowerPatterns.forEach(p => { lowerCount += patternCounts[p] || 0; });
            upperPatterns.forEach(p => { upperCount += patternCounts[p] || 0; });
            
            // Find dominant pattern
            const hingeCount = patternCounts['hinge'] || 0;
            const squatCount = patternCounts['squat'] || 0;
            const lungeCount = patternCounts['lunge'] || 0;
            const pushCount = patternCounts['push'] || 0;
            const pullCount = patternCounts['pull'] || 0;
            
            // Check for clear dominance (at least 2 exercises AND > 40% of total)
            const dominanceThreshold = Math.max(2, Math.ceil(total * 0.4));
            
            // Check specific dominance
            if (hingeCount >= dominanceThreshold && hingeCount > squatCount && hingeCount > pushCount) {
                return 'HINGE FOCUS';
            }
            if (squatCount >= dominanceThreshold && squatCount > hingeCount && squatCount > pushCount) {
                return 'SQUAT FOCUS';
            }
            if (pushCount >= dominanceThreshold && pushCount > pullCount && pushCount > lowerCount) {
                return 'PUSH FOCUS';
            }
            if (pullCount >= dominanceThreshold && pullCount > pushCount && pullCount >= lowerCount) {
                return 'PULL FOCUS';
            }
            
            // Check upper vs lower dominance
            if (lowerCount >= upperCount + 2) {
                return 'LOWER BODY';
            }
            if (upperCount >= lowerCount + 2) {
                return 'UPPER BODY';
            }
            
            // No clear dominance - it's a balanced session
            return 'FULL BODY';
        }

        function formatExercise(exercise, params, level, weekProgression, useCluster = false, useLadder = false, intensityProfile = 'medium', intensityParams = null) {
            const method = params.method;
            let prescription = {};
            const isDeload = weekProgression.isDeload;
            const phase = weekProgression.phase || 'accumulation';
            
            // Get intensity params with fallback
            const intParams = intensityParams || strengthIntensityParams[intensityProfile] || strengthIntensityParams.medium;

            // Volume caps
            const maxClusterRepsPerExercise = 30;
            const maxLadderRepsPerExercise = 40; // Reduced from 45

            if (method === 'ladder' && useLadder) {
                // STRENGTH: Phase-based and intensity-based ladder selection
                let ladderSource;
                let numLadders = weekProgression.numLadders || 3;
                
                // Select ladder type based on phase and intensity
                if (isDeload) {
                    ladderSource = params.ladders;
                    numLadders = 2;
                } else if (intensityProfile === 'light') {
                    ladderSource = params.laddersLight || params.ladders;
                    numLadders = Math.max(2, Math.floor(numLadders * intParams.ladderMultiplier));
                } else if (phase === 'intensification' || phase === 'realization') {
                    ladderSource = params.laddersIntense || params.ladders;
                    if (phase === 'realization') {
                        numLadders = Math.max(2, numLadders - 1);
                    }
                } else {
                    ladderSource = params.ladders;
                }
                
                const baseLadder = ladderSource[level] || ladderSource.intermediate;
                let rungs = [...baseLadder.rungs];
                
                // Apply intensity multiplier for MEDIUM days
                if (intensityProfile === 'medium' && phase === 'accumulation') {
                    numLadders = Math.max(2, Math.floor(numLadders * intParams.ladderMultiplier));
                }
                
                let totalReps = rungs.reduce((a, b) => a + b, 0) * numLadders;
                
                // Enforce volume cap
                while (totalReps > maxLadderRepsPerExercise && numLadders > 2) {
                    numLadders--;
                    totalReps = rungs.reduce((a, b) => a + b, 0) * numLadders;
                }

                // Load guidance based on phase
                let loadGuidance = '';
                if (phase === 'intensification' || phase === 'realization') {
                    loadGuidance = '↑ SALI DI KB';
                } else if (isDeload) {
                    loadGuidance = 'Stesso KB di W1, RPE 6-7';
                }

                prescription = {
                    name: exercise.name,
                    pattern: exercise.pattern,
                    method: 'ladder',
                    ladderRungs: rungs.join('-'),
                    numLadders: numLadders,
                    totalReps: totalReps,
                    rungRest: '30-60s',
                    ladderRest: '2-3 min',
                    isDeload: isDeload,
                    phase: phase,
                    loadGuidance: loadGuidance,
                    weekNote: weekProgression.note,
                    intensityProfile: intensityProfile,
                    isPrimary: true
                };
            } else if (method === 'cluster' && useCluster) {
                // POWER: Cluster logic with phase differentiation
                const baseCluster = params.clusters[level] || params.clusters.intermediate;
                let breakdown = [...baseCluster.breakdown];
                
                let numClusters = weekProgression.numClusters || 3;
                const phase = weekProgression.phase || 'technical';
                
                // Velocity phase: shorter clusters for max speed
                if (weekProgression.shorterClusters) {
                    breakdown = [2, 2];  // Shorter clusters = better power output
                }
                
                // Technical phase: can add rep to build volume
                if (weekProgression.addRep && !isDeload && phase === 'technical') {
                    breakdown[breakdown.length - 1] += 1;
                }
                
                // Apply intensity multiplier (H/L/M system)
                if (intensityProfile === 'light') {
                    numClusters = Math.max(2, Math.floor(numClusters * 0.5));
                } else if (intensityProfile === 'medium') {
                    numClusters = Math.max(2, Math.floor(numClusters * 0.7));
                }
                
                // Deload: reduce significantly
                if (isDeload) {
                    numClusters = Math.min(numClusters, 2);
                }
                
                const totalRepsPerCluster = breakdown.reduce((a, b) => a + b, 0);
                let totalReps = totalRepsPerCluster * numClusters;
                
                // Power training: strict volume cap (quality over quantity)
                const maxPowerReps = phase === 'velocity' ? 18 : 24;
                while (totalReps > maxPowerReps && numClusters > 2) {
                    numClusters--;
                    totalReps = totalRepsPerCluster * numClusters;
                }
                
                const breakdownStr = breakdown.join('+');
                
                // Longer rest for power (especially velocity phase)
                const interRest = phase === 'velocity' ? '3-4 min' : '2.5-3 min';

                prescription = {
                    name: exercise.name,
                    pattern: exercise.pattern,
                    method: 'cluster',
                    numClusters: numClusters,
                    clusterBreakdown: breakdownStr,
                    totalRepsPerCluster: totalRepsPerCluster,
                    intraRest: baseCluster.intraRest + 's',
                    interRest: interRest,
                    isDeload: isDeload,
                    phase: phase,
                    weekNote: weekProgression.note,
                    intensityProfile: intensityProfile,
                    isPrimary: true
                };
            } else {
                // STRAIGHT SETS: for secondary exercises or non-strength goals
                let baseSets = randomInRange(params.sets.min, params.sets.max);
                let setsModifier = weekProgression.setsModifier || 0;
                let sets = Math.max(3, baseSets + setsModifier); // Minimum 3 for main work
                
                // Apply intensity multiplier for Light/Medium days
                const setsMultiplier = intParams.straightSetsMultiplier || 0.75;
                if (intensityProfile === 'light') {
                    sets = Math.floor(sets * 0.7); // Reduce but will be capped below
                } else if (intensityProfile === 'medium') {
                    sets = Math.floor(sets * setsMultiplier);
                }
                
                // MAIN WORK MINIMUM: 3 sets (except deload where 2 is allowed)
                const minSetsMain = isDeload ? 2 : 3;
                sets = Math.max(minSetsMain, sets);
                
                // Volume cap: max 4 sets for general fitness to stay within time budget
                if (params.maxRepsPerExercise) {
                    const avgReps = (params.repRange.min + params.repRange.max) / 2;
                    const maxSetsForCap = Math.floor(params.maxRepsPerExercise / avgReps);
                    sets = Math.min(sets, maxSetsForCap);
                    // Re-apply minimum after cap (cap should not go below minimum)
                    sets = Math.max(minSetsMain, sets);
                }
                
                // Hard cap: never exceed 4 sets for non-strength methods
                if (method !== 'ladder' && method !== 'cluster') {
                    sets = Math.min(sets, 4);
                }
                
                // Rep range for secondary work in strength program
                const repMin = params.repRange.min;
                const repMax = params.repRange.max;
                let repDisplay;
                
                if (weekProgression.targetReps) {
                    const repRange = repMax - repMin;
                    switch (weekProgression.targetReps) {
                        case 'low':
                            repDisplay = `${repMin}-${repMin + Math.floor(repRange * 0.25)}`;
                            break;
                        case 'mid-low':
                            repDisplay = `${repMin + Math.floor(repRange * 0.25)}-${repMin + Math.floor(repRange * 0.5)}`;
                            break;
                        case 'mid':
                            repDisplay = `${repMin + Math.floor(repRange * 0.33)}-${repMin + Math.floor(repRange * 0.66)}`;
                            break;
                        case 'mid-high':
                            repDisplay = `${repMin + Math.floor(repRange * 0.5)}-${repMin + Math.floor(repRange * 0.75)}`;
                            break;
                        case 'high':
                            repDisplay = `${repMin + Math.floor(repRange * 0.75)}-${repMax}`;
                            break;
                        default:
                            repDisplay = `${repMin}-${repMax}`;
                    }
                } else {
                    let repsModifier = weekProgression.repsModifier || 0;
                    const adjustedMin = Math.min(repMin + repsModifier, repMax);
                    const adjustedMax = Math.min(repMax + repsModifier, repMax + 3);
                    repDisplay = `${adjustedMin}-${adjustedMax}`;
                }
                
                // Handle rest
                let restSeconds = { ...params.restSeconds };
                if (weekProgression.restModifier) {
                    restSeconds.min = Math.max(15, restSeconds.min + weekProgression.restModifier);
                    restSeconds.max = Math.max(30, restSeconds.max + weekProgression.restModifier);
                }
                
                const restMin = Math.floor(restSeconds.min / 60);
                const restMax = Math.floor(restSeconds.max / 60);
                const restSecMin = restSeconds.min % 60;
                const restSecMax = restSeconds.max % 60;
                
                let restStr;
                if (restMin === restMax && restSecMin === restSecMax) {
                    restStr = `${restMin}:${restSecMin.toString().padStart(2, '0')}`;
                } else {
                    restStr = `${restMin}:${restSecMin.toString().padStart(2, '0')}-${restMax}:${restSecMax.toString().padStart(2, '0')}`;
                }

                prescription = {
                    name: exercise.name,
                    pattern: exercise.pattern,
                    method: 'straight',
                    sets: sets,
                    repRange: exercise.pattern === 'carry' ? '30-40m' : repDisplay,
                    rest: restStr,
                    tempo: params.tempo,
                    isDeload: isDeload,
                    weekNote: weekProgression.note,
                    intensityProfile: intensityProfile,
                    isPrimary: false
                };
            }

            return prescription;
        }

        function formatAccessory(exercise, params, intensityProfile = 'medium') {
            // Fixed range for accessories
            const defaultMin = 8;
            const defaultMax = 15;
            
            // Reduce accessory volume on light days
            let sets = randomInRange(2, 3);
            if (intensityProfile === 'light') {
                sets = 2;
            }

            return {
                name: exercise.name,
                pattern: exercise.pattern,
                method: 'straight',
                sets: sets,
                repRange: exercise.pattern === 'carry' ? '30-40m' : `${defaultMin}-${defaultMax}`,
                rest: '0:45-1:00'
            };
        }

        function randomInRange(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderProgram(program, preserveEdits = false) {
            // Store current program for editing
            // Only reset edits if this is a new program (not a re-render after edit)
            if (!preserveEdits || state.currentProgram !== program) {
                state.exerciseEdits = {};
                state.propagatedEdits = new Set();
            }
            state.currentProgram = program;
            
            let html = `
                <div class="program-summary">
                    <div class="summary-card">
                        <div class="metric">${program.weeks}</div>
                        <div class="metric-label">${t('program.weeks')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="metric">${program.frequency}x</div>
                        <div class="metric-label">${t('program.perWeek')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="metric">${program.duration}</div>
                        <div class="metric-label">${t('program.minSession')}</div>
                    </div>
                    <div class="summary-card">
                        <div class="metric">RPE ${program.rpe.min}-${program.rpe.max}</div>
                        <div class="metric-label">${t('program.intensity')}</div>
                    </div>
                </div>
                
                <div class="progression-overview">
                    <h4>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3,13H5V11H3V13M3,17H5V15H3V17M3,9H5V7H3V9M7,13H21V11H7V13M7,17H21V15H7V17M7,7V9H21V7H7Z"/></svg>
                        ${t('program.progression')}: ${program.progressionDescription}
                    </h4>
                    <div class="progression-timeline">
            `;
            
            // Show progression timeline
            program.weeklyProgram.forEach((weekData, idx) => {
                const isDeload = weekData.progression.isDeload;
                html += `
                    <div class="progression-week ${isDeload ? 'deload' : ''}">
                        <div class="week-num">W${weekData.week}</div>
                        <div class="week-focus">${weekData.progression.note}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;

            // Method explanation for ladders/clusters
            if (program.method === 'ladder') {
                html += `
                    <div class="method-explanation">
                        <h4><span class="tag method-tag ladder">${t('methods.ladder')}</span> ${t('methods.trainingMethod')}</h4>
                        <p>${t('methods.ladderExplanation')}</p>
                        <div class="example">
                            <strong>${t('methods.example')}:</strong> ${t('methods.ladderExample')}
                        </div>
                    </div>
                `;
            } else if (program.method === 'cluster') {
                html += `
                    <div class="method-explanation">
                        <h4><span class="tag method-tag cluster">${t('methods.cluster')}</span> ${t('methods.trainingMethod')}</h4>
                        <p>${t('methods.clusterExplanation')}</p>
                        <div class="example">
                            <strong>${t('methods.example')}:</strong> ${t('methods.clusterExample')}
                        </div>
                        <div class="example" style="margin-top: 10px; border-left-color: #cc5500;">
                            <strong>${t('methods.note')}:</strong> ${t('methods.clusterNote')}
                        </div>
                    </div>
                `;
            }

            // H/L/M intensity explanation (for all goals with 3+ sessions)
            if (program.frequency >= 3) {
                html += `
                    <div class="method-explanation">
                        <h4>
                            <span class="intensity-badge heavy">H</span>
                            <span class="intensity-badge light">L</span>
                            <span class="intensity-badge medium">M</span>
                            ${t('hlm.title')}
                        </h4>
                        <p>${t('hlm.description')}</p>
                        <div class="example">
                            <strong>HEAVY:</strong> ${t('hlm.heavyDesc')}<br>
                            <strong>LIGHT:</strong> ${t('hlm.lightDesc')}<br>
                            <strong>MEDIUM:</strong> ${t('hlm.mediumDesc')}
                        </div>
                    </div>
                `;
            }

            html += `<div class="week-tabs">`;
            for (let w = 1; w <= program.weeks; w++) {
                const weekData = program.weeklyProgram[w - 1];
                const isDeload = weekData.progression.isDeload;
                html += `<button class="week-tab ${w === 1 ? 'active' : ''} ${isDeload ? 'deload-tab' : ''}" data-week="${w}">
                    ${t('program.week')} ${w}${isDeload ? ' ⟳' : ''}
                </button>`;
            }
            html += `</div>`;
            
            // Render each week's content
            html += `<div class="weeks-container">`;
            
            program.weeklyProgram.forEach((weekData, weekIdx) => {
                const isDeload = weekData.progression.isDeload;
                html += `<div class="week-content ${weekIdx === 0 ? 'active' : ''}" data-week="${weekData.week}">`;
                
                // Week header with progression note
                html += `
                    <div class="week-header ${isDeload ? 'deload-header' : ''}">
                        <div class="week-title">${t('program.week')} ${weekData.week} ${isDeload ? '- DELOAD' : ''}</div>
                        <div class="week-progression-note">${weekData.progression.note}</div>
                    </div>
                `;
                
                weekData.sessions.forEach(session => {
                    const intensityBadge = session.intensityProfile ? 
                        `<span class="intensity-badge ${session.intensityProfile}">${session.intensityProfile.toUpperCase()}</span>` : '';
                    const rpeBadge = session.rpeTarget ? 
                        `<span class="rpe-badge">RPE ${session.rpeTarget}</span>` : '';
                    
                    html += `
                        <div class="workout-block main ${isDeload ? 'deload-block' : ''}">
                            <div class="workout-block-header">
                                <h3>
                                    <span class="phase-tag">${isDeload ? 'DELOAD' : t('program.day') + ' ' + session.day}</span>
                                    ${translations[state.currentLang].sessions[session.name] || session.name}
                                    ${!isDeload ? intensityBadge : ''}
                                    ${!isDeload ? rpeBadge : ''}
                                </h3>
                                <span class="duration-badge">${program.duration} MIN</span>
                            </div>
                            ${session.intensityDescription ? `<div class="intensity-description">${session.intensityDescription}</div>` : ''}
                            <div class="exercise-list-output">
                    `;

                    session.main.forEach((ex, i) => {
                        html += renderExerciseItem(ex, i + 1, weekData.week, session.day, i, 'main');
                    });

                    html += `</div></div>`;

                    if (session.accessory.length > 0) {
                        html += `
                            <div class="workout-block accessory">
                                <div class="workout-block-header">
                                    <h3>
                                        <span class="phase-tag">${t('program.accessory')}</span>
                                        ${t('program.supplemental')}
                                    </h3>
                                </div>
                                <div class="exercise-list-output">
                        `;

                        session.accessory.forEach((ex, i) => {
                            html += renderExerciseItem(ex, String.fromCharCode(65 + i), weekData.week, session.day, i, 'accessory');
                        });

                        html += `</div></div>`;
                    }

                    if (session.finisher && !isDeload) {
                        html += `
                            <div class="workout-block finisher">
                                <div class="workout-block-header">
                                    <h3>
                                        <span class="phase-tag">${t('program.finisher')}</span>
                                        ${session.finisher.name}
                                    </h3>
                                    <span class="duration-badge">${session.finisher.duration}</span>
                                </div>
                                <div class="exercise-list-output">
                                    <div class="exercise-item" onclick="openTimer('${session.finisher.name}')">
                                        <div class="exercise-number">★</div>
                                        <div class="exercise-details">
                                            <h4>${session.finisher.name}</h4>
                                            <p>${session.finisher.desc}</p>
                                        </div>
                                        <div class="exercise-prescription">
                                            <div class="sets-reps">WORK</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (session.finisher && isDeload) {
                        html += `
                            <div class="workout-block finisher deload-block">
                                <div class="workout-block-header">
                                    <h3>
                                        <span class="phase-tag">${t('program.optional')}</span>
                                        ${t('program.lightFinisher')}
                                    </h3>
                                </div>
                                <div class="exercise-list-output">
                                    <div class="exercise-item">
                                        <div class="exercise-number">~</div>
                                        <div class="exercise-details">
                                            <h4>${t('program.easyMovement')}</h4>
                                            <p>${t('program.easyMovementDesc')}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `</div>`; // Close week-content
            });
            
            html += `</div>`; // Close weeks-container

            // Notes section
            html += `
                <div class="program-notes">
                    <h4>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17L7,12H10V8H14V12H17L12,17Z"/></svg>
                        TRAINING GUIDELINES
                    </h4>
                    <ul>
            `;

            program.notes.forEach(note => {
                html += `<li>${note}</li>`;
            });

            html += `
                    </ul>
                </div>
            `;

            // Autoregulation section (for strength programs)
            if (program.autoregulation && program.autoregulation.length > 0) {
                html += `
                    <div class="autoregulation-notes">
                        <h4>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10Z"/></svg>
                            ${t('program.autoregulation')}
                        </h4>
                        <ul>
                `;
                
                program.autoregulation.forEach(rule => {
                    html += `<li>${rule}</li>`;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }

            html += `
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="handlePrint()">
                        <svg viewBox="0 0 24 24"><path d="M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z"/></svg>
                        ${t('program.print')}
                    </button>
                    <button class="action-btn" onclick="generateProgram()">
                        <svg viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/></svg>
                        ${t('program.regenerate')}
                    </button>
                </div>
            `;

            programOutput.innerHTML = html;

            // Week tab switching
            document.querySelectorAll('.week-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const week = e.target.dataset.week;
                    
                    // Update tabs
                    document.querySelectorAll('.week-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Update content
                    document.querySelectorAll('.week-content').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.week-content[data-week="${week}"]`).classList.add('active');
                });
            });
        }

        function renderExerciseItem(ex, number, week = null, day = null, index = null, type = 'main') {
            // Check if this exercise has been edited
            const editKey = `${week}-${day}-${type}-${index}`;
            const edit = state.exerciseEdits[editKey];
            
            // Apply edits if they exist
            let displayEx = { ...ex };
            if (edit) {
                displayEx = { ...ex, ...edit };
                // Recalculate totals if needed
                if (displayEx.method === 'ladder' && edit.ladderRungs) {
                    const rungs = edit.ladderRungs.split('-').map(n => parseInt(n.trim()));
                    displayEx.totalReps = rungs.reduce((a, b) => a + b, 0) * displayEx.numLadders;
                }
                if (displayEx.method === 'cluster' && edit.clusterBreakdown) {
                    const breakdown = edit.clusterBreakdown.split('+').map(n => parseInt(n.trim()));
                    displayEx.totalRepsPerCluster = breakdown.reduce((a, b) => a + b, 0);
                }
            }
            
            let prescriptionHtml = '';
            let methodTagHtml = '';
            const deloadClass = displayEx.isDeload ? 'deload-exercise' : '';
            const priorityClass = displayEx.isPrimary ? 'primary-lift' : 'secondary-lift';
            const editedClass = edit ? 'edited' : '';
            const propagatedClass = state.propagatedEdits.has(editKey) ? 'propagated' : '';
            
            // Add user note if present
            const userNoteHtml = displayEx.userNote ? 
                `<div class="user-note">📝 ${displayEx.userNote}</div>` : '';

            if (displayEx.method === 'ladder') {
                methodTagHtml = `<span class="method-tag ladder">${t('methods.ladder')}</span>`;
                const loadGuidanceHtml = displayEx.loadGuidance ? 
                    `<div class="load-guidance">${displayEx.loadGuidance}</div>` : '';
                prescriptionHtml = `
                    <div class="sets-reps">${displayEx.numLadders} × (${displayEx.ladderRungs})</div>
                    <div class="rep-range-note">${t('program.total')}: ~${displayEx.totalReps} ${t('program.reps')}</div>
                    <div class="rest">${t('program.rungs')}: ${displayEx.rungRest} | ${t('program.ladders')}: ${displayEx.ladderRest}</div>
                    ${loadGuidanceHtml}
                    ${userNoteHtml}
                `;
            } else if (displayEx.method === 'cluster') {
                methodTagHtml = `<span class="method-tag cluster">${t('methods.cluster')}</span>`;
                prescriptionHtml = `
                    <div class="sets-reps">${displayEx.numClusters} × (${displayEx.clusterBreakdown})</div>
                    <div class="rep-range-note">${displayEx.totalRepsPerCluster} ${t('program.reps')}/cluster</div>
                    <div class="rest">${t('program.intra')}: ${displayEx.intraRest} | ${t('program.inter')}: ${displayEx.interRest}</div>
                    ${userNoteHtml}
                `;
            } else {
                methodTagHtml = `<span class="method-tag straight">${t('methods.straight')}</span>`;
                prescriptionHtml = `
                    <div class="sets-reps">${displayEx.sets} × ${displayEx.repRange}</div>
                    <div class="rest">${t('program.rest')}: ${displayEx.rest}</div>
                    ${displayEx.tempo ? `<div class="tempo">${t('program.tempo')}: ${displayEx.tempo}</div>` : ''}
                    ${userNoteHtml}
                `;
            }

            // Create edit data attribute for click handler
            const editData = week !== null ? 
                `data-week="${week}" data-day="${day}" data-index="${index}" data-type="${type}"` : '';

            return `
                <div class="exercise-item ${deloadClass} ${priorityClass} ${editedClass} ${propagatedClass}" 
                     onclick="openEditModal(${week}, ${day}, ${index}, '${type}')" ${editData}>
                    <div class="exercise-number">${number}</div>
                    <div class="exercise-details">
                        <h4>${displayEx.name}</h4>
                        <p>${displayEx.pattern.toUpperCase()} ${t('program.pattern')}</p>
                        ${methodTagHtml}
                    </div>
                    <div class="exercise-prescription">
                        ${prescriptionHtml}
                    </div>
                </div>
            `;
        }

        // Edit modal functions
        function openEditModal(week, day, index, type) {
            if (week === null || !state.currentProgram) return;
            
            // Find the exercise in the program
            const weekData = state.currentProgram.weeklyProgram.find(w => w.week === week);
            if (!weekData) return;
            
            const session = weekData.sessions.find(s => s.day === day);
            if (!session) return;
            
            const exerciseList = type === 'main' ? session.main : session.accessory;
            const exercise = exerciseList[index];
            if (!exercise) return;
            
            // Check for existing edits
            const editKey = `${week}-${day}-${type}-${index}`;
            const existingEdit = state.exerciseEdits[editKey] || {};
            
            // Store current edit target
            state.currentEditTarget = { week, day, index, type, exercise, editKey };
            
            // Populate modal
            document.getElementById('editExerciseName').textContent = exercise.name;
            document.getElementById('editExercisePattern').textContent = `${exercise.pattern.toUpperCase()} • Week ${week} Day ${day}`;
            
            // Show appropriate fields based on method
            document.getElementById('editLadderFields').style.display = 'none';
            document.getElementById('editClusterFields').style.display = 'none';
            document.getElementById('editStraightFields').style.display = 'none';
            
            if (exercise.method === 'ladder') {
                document.getElementById('editLadderFields').style.display = 'block';
                document.getElementById('editNumLadders').value = existingEdit.numLadders || exercise.numLadders;
                document.getElementById('editLadderRungs').value = existingEdit.ladderRungs || exercise.ladderRungs;
                document.getElementById('editMethodInfo').textContent = 
                    'Modifica il numero di ladders e le rungs. Aumenta le rungs per più volume, riducile per più intensità.';
            } else if (exercise.method === 'cluster') {
                document.getElementById('editClusterFields').style.display = 'block';
                document.getElementById('editNumClusters').value = existingEdit.numClusters || exercise.numClusters;
                document.getElementById('editClusterBreakdown').value = existingEdit.clusterBreakdown || exercise.clusterBreakdown;
                document.getElementById('editMethodInfo').textContent = 
                    'Modifica il numero di cluster e il breakdown. Mantieni le pause intra-cluster brevi per preservare la potenza.';
            } else {
                document.getElementById('editStraightFields').style.display = 'block';
                document.getElementById('editSets').value = existingEdit.sets || exercise.sets;
                document.getElementById('editReps').value = existingEdit.repRange || exercise.repRange;
                document.getElementById('editMethodInfo').textContent = 
                    'Modifica sets e reps. Per l\'ipertrofia usa 8-12 reps, per la forza 3-6 reps.';
            }
            
            // Set notes
            document.getElementById('editNotes').value = existingEdit.userNote || '';
            
            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            state.currentEditTarget = null;
        }

        function saveEdit() {
            if (!state.currentEditTarget) return;
            
            const { week, day, index, type, exercise, editKey } = state.currentEditTarget;
            const edit = {};
            
            // Collect edited values based on method
            if (exercise.method === 'ladder') {
                edit.numLadders = parseInt(document.getElementById('editNumLadders').value);
                edit.ladderRungs = document.getElementById('editLadderRungs').value.trim();
            } else if (exercise.method === 'cluster') {
                edit.numClusters = parseInt(document.getElementById('editNumClusters').value);
                edit.clusterBreakdown = document.getElementById('editClusterBreakdown').value.trim();
            } else {
                edit.sets = parseInt(document.getElementById('editSets').value);
                edit.repRange = document.getElementById('editReps').value.trim();
            }
            
            // Add user note if present
            const userNote = document.getElementById('editNotes').value.trim();
            if (userNote) {
                edit.userNote = userNote;
            }
            
            // Store pending edit and show propagation modal
            state.pendingEdit = {
                edit,
                exerciseName: exercise.name,
                method: exercise.method,
                week,
                day,
                index,
                type,
                editKey
            };
            
            // Close edit modal
            closeEditModal();
            
            // Show propagation modal
            showPropagateModal();
        }

        function showPropagateModal() {
            const { edit, exerciseName, method, week, day } = state.pendingEdit;
            const totalWeeks = state.currentProgram.weeks;
            
            // Set exercise name
            document.getElementById('propagateExerciseName').textContent = exerciseName;
            
            // Create changes summary
            let changesSummary = '';
            if (method === 'ladder') {
                changesSummary = `${edit.numLadders} ladders × (${edit.ladderRungs})`;
            } else if (method === 'cluster') {
                changesSummary = `${edit.numClusters} clusters × (${edit.clusterBreakdown})`;
            } else {
                changesSummary = `${edit.sets} × ${edit.repRange}`;
            }
            if (edit.userNote) {
                changesSummary += ` • Note: "${edit.userNote}"`;
            }
            document.getElementById('propagateChangesSummary').textContent = changesSummary;
            
            // Set current week/day info
            document.getElementById('propCurrentWeek').textContent = week;
            document.getElementById('propCurrentDay').textContent = day;
            document.getElementById('propTotalWeeks').textContent = totalWeeks;
            
            // Populate range selectors
            const startSelect = document.getElementById('propRangeStart');
            const endSelect = document.getElementById('propRangeEnd');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            for (let w = 1; w <= totalWeeks; w++) {
                startSelect.innerHTML += `<option value="${w}" ${w === 1 ? 'selected' : ''}>Week ${w}</option>`;
                endSelect.innerHTML += `<option value="${w}" ${w === totalWeeks ? 'selected' : ''}>Week ${w}</option>`;
            }
            
            // Reset to "this week only" option
            document.querySelector('input[name="propagate"][value="this"]').checked = true;
            document.getElementById('propagateRangeSelector').style.display = 'none';
            
            // Update preview
            updatePropagatePreview();
            
            // Show modal
            document.getElementById('propagateModal').classList.add('active');
        }

        function updatePropagatePreview() {
            const { week, day } = state.pendingEdit;
            const totalWeeks = state.currentProgram.weeks;
            const selectedOption = document.querySelector('input[name="propagate"]:checked').value;
            
            let weeksToApply = [];
            
            switch (selectedOption) {
                case 'this':
                    weeksToApply = [week];
                    break;
                case 'all':
                    weeksToApply = Array.from({ length: totalWeeks }, (_, i) => i + 1);
                    break;
                case 'range':
                    const start = parseInt(document.getElementById('propRangeStart').value);
                    const end = parseInt(document.getElementById('propRangeEnd').value);
                    for (let w = Math.min(start, end); w <= Math.max(start, end); w++) {
                        weeksToApply.push(w);
                    }
                    break;
                case 'same-day':
                    weeksToApply = Array.from({ length: totalWeeks }, (_, i) => i + 1);
                    break;
            }
            
            // Show/hide range selector
            document.getElementById('propagateRangeSelector').style.display = 
                selectedOption === 'range' ? 'block' : 'none';
            
            // Update preview badges
            const previewContainer = document.getElementById('previewWeeks');
            previewContainer.innerHTML = '';
            
            weeksToApply.forEach(w => {
                const weekData = state.currentProgram.weeklyProgram.find(wp => wp.week === w);
                const isDeload = weekData?.progression?.isDeload;
                const isCurrent = w === week;
                
                let classes = 'preview-week-badge';
                if (isCurrent) classes += ' current';
                if (isDeload) classes += ' deload';
                
                let label = `W${w}`;
                if (selectedOption === 'same-day') label += ` D${day}`;
                if (isDeload) label += ' (Deload)';
                
                previewContainer.innerHTML += `<span class="${classes}">${label}</span>`;
            });
        }

        function applyPropagatedEdits() {
            const { edit, exerciseName, week, day, index, type, editKey } = state.pendingEdit;
            const totalWeeks = state.currentProgram.weeks;
            const selectedOption = document.querySelector('input[name="propagate"]:checked').value;
            
            let weeksToApply = [];
            let daysToApply = null; // null means all days with this exercise
            
            switch (selectedOption) {
                case 'this':
                    weeksToApply = [week];
                    daysToApply = [day];
                    break;
                case 'all':
                    weeksToApply = Array.from({ length: totalWeeks }, (_, i) => i + 1);
                    break;
                case 'range':
                    const start = parseInt(document.getElementById('propRangeStart').value);
                    const end = parseInt(document.getElementById('propRangeEnd').value);
                    for (let w = Math.min(start, end); w <= Math.max(start, end); w++) {
                        weeksToApply.push(w);
                    }
                    break;
                case 'same-day':
                    weeksToApply = Array.from({ length: totalWeeks }, (_, i) => i + 1);
                    daysToApply = [day];
                    break;
            }
            
            // Apply edits to selected weeks
            let appliedCount = 0;
            
            weeksToApply.forEach(targetWeek => {
                const weekData = state.currentProgram.weeklyProgram.find(wp => wp.week === targetWeek);
                if (!weekData) return;
                
                weekData.sessions.forEach(session => {
                    // If daysToApply is specified, only apply to those days
                    if (daysToApply && !daysToApply.includes(session.day)) return;
                    
                    const exerciseList = type === 'main' ? session.main : session.accessory;
                    
                    // Find matching exercise by name
                    exerciseList.forEach((ex, exIndex) => {
                        if (ex.name === exerciseName) {
                            const targetEditKey = `${targetWeek}-${session.day}-${type}-${exIndex}`;
                            
                            // Apply edit
                            state.exerciseEdits[targetEditKey] = { ...edit };
                            
                            // Track if this was propagated (not the original)
                            if (targetWeek !== week || session.day !== day) {
                                state.propagatedEdits.add(targetEditKey);
                            }
                            
                            appliedCount++;
                        }
                    });
                });
            });
            
            // Close propagate modal
            closePropagateModal();
            
            // Re-render program
            renderProgram(state.currentProgram, true);
            
            // Show confirmation
            showPropagateConfirmation(appliedCount);
        }

        function closePropagateModal() {
            document.getElementById('propagateModal').classList.remove('active');
            state.pendingEdit = null;
        }

        function showPropagateConfirmation(count) {
            const toast = document.createElement('div');
            toast.className = 'preset-toast';
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                <span>Modifica applicata a ${count} esercizi!</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2500);
        }

        function showEditConfirmation() {
            const toast = document.createElement('div');
            toast.className = 'preset-toast';
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                <span>Modifica salvata!</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2000);
        }

        // Edit modal event listeners
        document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        document.getElementById('saveEdit').addEventListener('click', saveEdit);
        
        // Close modal on outside click
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });

        // Propagate modal event listeners
        document.getElementById('closePropagateModal').addEventListener('click', closePropagateModal);
        document.getElementById('cancelPropagate').addEventListener('click', closePropagateModal);
        document.getElementById('confirmPropagate').addEventListener('click', applyPropagatedEdits);
        
        // Update preview when propagation option changes
        document.querySelectorAll('input[name="propagate"]').forEach(radio => {
            radio.addEventListener('change', updatePropagatePreview);
        });
        
        // Update preview when range changes
        document.getElementById('propRangeStart').addEventListener('change', updatePropagatePreview);
        document.getElementById('propRangeEnd').addEventListener('change', updatePropagatePreview);
        
        // Close propagate modal on outside click
        document.getElementById('propagateModal').addEventListener('click', (e) => {
            if (e.target.id === 'propagateModal') {
                closePropagateModal();
            }
        });

        // Initialize language on page load
        updateLanguage();
    </script>
</body>
</html>
